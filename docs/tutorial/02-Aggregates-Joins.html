<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aggregating and joining data &mdash; Ibis 0+untagged.1.gdce1945 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Expressions, lazy mode and logging queries" href="03-Expressions-Lazy-Mode-Logging.html" />
    <link rel="prev" title="Introduction to Ibis" href="01-Introduction-to-Ibis.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Ibis
            <img src="../_static/logo-wide.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0+untagged.1.gdce1945
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01-Introduction-to-Ibis.html">Introduction to Ibis</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Aggregating and joining data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Expressions">Expressions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Aggregating-data">Aggregating data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Joining-data">Joining data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="03-Expressions-Lazy-Mode-Logging.html">Expressions, lazy mode and logging queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-More-Value-Expressions.html">More Value Expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="05-IO-Create-Insert-External-Data.html">Creating and inserting data</a></li>
<li class="toctree-l2"><a class="reference internal" href="06-Advanced-Topics-ComplexFiltering.html">Advanced Topics: Additional Filtering</a></li>
<li class="toctree-l2"><a class="reference internal" href="07-Advanced-Topics-Analytics-Tools.html">Advanced Topics: Analytics Tools</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/index.html">User guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../backends/index.html">Backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release/index.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ibis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Tutorial</a> &raquo;</li>
      <li>Aggregating and joining data</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorial/02-Aggregates-Joins.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Aggregating-and-joining-data">
<h1>Aggregating and joining data<a class="headerlink" href="#Aggregating-and-joining-data" title="Permalink to this headline">¶</a></h1>
<p>This is the second introductory tutorial to Ibis. If you are new to Ibis, you may want to start by the first tutorial, <em>01-Introduction-to-Ibis</em>.</p>
<p>In the first tutorial, we saw how to operate on the data of a table. We will work again with the <code class="docutils literal notranslate"><span class="pre">countries</span></code> table as we did previously.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">ibis</span>


<span class="n">ibis</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;geography.db&#39;</span><span class="p">))</span>
<span class="n">countries</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;countries&#39;</span><span class="p">)</span>

<span class="n">countries</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;continent&#39;</span><span class="p">,</span> <span class="s1">&#39;area_km2&#39;</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
                     name continent   area_km2  population
0                 Andorra        EU      468.0       84000
1    United Arab Emirates        AS    82880.0     4975593
2             Afghanistan        AS   647500.0    29121286
3     Antigua and Barbuda        NA      443.0       86754
4                Anguilla        NA      102.0       13254
..                    ...       ...        ...         ...
247                 Yemen        AS   527970.0    23495361
248               Mayotte        AF      374.0      159042
249          South Africa        AF  1219912.0    49000000
250                Zambia        AF   752614.0    13460305
251              Zimbabwe        AF   390580.0    13061000

[252 rows x 4 columns]
</pre></div></div>
</div>
<section id="Expressions">
<h2>Expressions<a class="headerlink" href="#Expressions" title="Permalink to this headline">¶</a></h2>
<p>We will continue by exploring the data by continent. We will start by creating an expression with the continent names, since our table only contains the abbreviations.</p>
<p>An expression is one or more operations performed over the data. They can be used to retrieve the data or to build more complex operations.</p>
<p>In this case we will use a <code class="docutils literal notranslate"><span class="pre">case</span></code> conditional statement to replace values depending on a condition. A <code class="docutils literal notranslate"><span class="pre">case</span></code> expression will return a case builder, and must be followed by one or more <code class="docutils literal notranslate"><span class="pre">when</span></code> calls, optionally an <code class="docutils literal notranslate"><span class="pre">else_</span></code> call, and must end with a call to <code class="docutils literal notranslate"><span class="pre">end</span></code>, to complete the full expression. The expression where <code class="docutils literal notranslate"><span class="pre">case</span></code> is called (<code class="docutils literal notranslate"><span class="pre">countries['continent']</span></code> in this case) is evaluated to see if it’s equal to any of the first arguments of the calls to <code class="docutils literal notranslate"><span class="pre">when</span></code>. And the second argument
is returned. If the value does not match any of the <code class="docutils literal notranslate"><span class="pre">when</span></code> values, the value of <code class="docutils literal notranslate"><span class="pre">else_</span></code> is returned.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">continent_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">countries</span><span class="p">[</span><span class="s1">&#39;continent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">case</span><span class="p">()</span>
                                        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;NA&#39;</span><span class="p">,</span> <span class="s1">&#39;North America&#39;</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;SA&#39;</span><span class="p">,</span> <span class="s1">&#39;South America&#39;</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;EU&#39;</span><span class="p">,</span> <span class="s1">&#39;Europe&#39;</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;AF&#39;</span><span class="p">,</span> <span class="s1">&#39;Africa&#39;</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;AS&#39;</span><span class="p">,</span> <span class="s1">&#39;Asia&#39;</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;OC&#39;</span><span class="p">,</span> <span class="s1">&#39;Oceania&#39;</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="s1">&#39;AN&#39;</span><span class="p">,</span> <span class="s1">&#39;Anctartica&#39;</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">else_</span><span class="p">(</span><span class="s1">&#39;Unknown continent&#39;</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">end</span><span class="p">()</span>
                                        <span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s1">&#39;continent_name&#39;</span><span class="p">))</span>
<span class="n">continent_name</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0             Europe
1               Asia
2               Asia
3      North America
4      North America
           ...
247             Asia
248           Africa
249           Africa
250           Africa
251           Africa
Name: tmp, Length: 252, dtype: object
</pre></div></div>
</div>
<p>What we did is take the values of the column <code class="docutils literal notranslate"><span class="pre">countries['continent']</span></code>, and we created a calculated column with the names of the continents, as defined in the <code class="docutils literal notranslate"><span class="pre">when</span></code> methods.</p>
<p>This calculated column is an expression. The computations didn’t happen when defining the <code class="docutils literal notranslate"><span class="pre">continent_name</span></code> variable, and the results are not stored. They have been computed when we printed its content.</p>
<p>We can see that by checking the type of <code class="docutils literal notranslate"><span class="pre">continent_name</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">type</span><span class="p">(</span><span class="n">continent_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ibis.expr.types.StringColumn
</pre></div></div>
</div>
<p>In the next tutorial we will see more about eager and lazy mode, and when operations are being executed. For now we can think that the query to the database happens only when we want to see the results.</p>
<p>The important part is that now we can use our <code class="docutils literal notranslate"><span class="pre">continent_name</span></code> expression in other expressions. For example, since this is a column (a <code class="docutils literal notranslate"><span class="pre">StringColumn</span></code> to be specific), we can use it as a column to query the countries table.</p>
<p>Note that when we created the expression we added <code class="docutils literal notranslate"><span class="pre">.name('continent_name')</span></code> to it, so the column has a name when being returned.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">countries</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">continent_name</span><span class="p">,</span> <span class="s1">&#39;area_km2&#39;</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
                     name continent_name   area_km2  population
0                 Andorra         Europe      468.0       84000
1    United Arab Emirates           Asia    82880.0     4975593
2             Afghanistan           Asia   647500.0    29121286
3     Antigua and Barbuda  North America      443.0       86754
4                Anguilla  North America      102.0       13254
..                    ...            ...        ...         ...
247                 Yemen           Asia   527970.0    23495361
248               Mayotte         Africa      374.0      159042
249          South Africa         Africa  1219912.0    49000000
250                Zambia         Africa   752614.0    13460305
251              Zimbabwe         Africa   390580.0    13061000

[252 rows x 4 columns]
</pre></div></div>
</div>
<p>Just for illustration, let’s repeat the same query, but renaming the expression to <code class="docutils literal notranslate"><span class="pre">continent</span></code> when using it in the list of columns to fetch.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">countries</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">continent_name</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s1">&#39;continent&#39;</span><span class="p">),</span> <span class="s1">&#39;area_km2&#39;</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
                     name      continent   area_km2  population
0                 Andorra         Europe      468.0       84000
1    United Arab Emirates           Asia    82880.0     4975593
2             Afghanistan           Asia   647500.0    29121286
3     Antigua and Barbuda  North America      443.0       86754
4                Anguilla  North America      102.0       13254
..                    ...            ...        ...         ...
247                 Yemen           Asia   527970.0    23495361
248               Mayotte         Africa      374.0      159042
249          South Africa         Africa  1219912.0    49000000
250                Zambia         Africa   752614.0    13460305
251              Zimbabwe         Africa   390580.0    13061000

[252 rows x 4 columns]
</pre></div></div>
</div>
</section>
<section id="Aggregating-data">
<h2>Aggregating data<a class="headerlink" href="#Aggregating-data" title="Permalink to this headline">¶</a></h2>
<p>Now, let’s group our data by continent, and let’s find the total population of each.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">countries</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">continent_name</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">countries</span><span class="p">[</span><span class="s1">&#39;population&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s1">&#39;total_population&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  continent_name  total_population
0         Africa        1021238685
1     Anctartica               170
2           Asia        4130584841
3         Europe         750724554
4  North America         540204371
5        Oceania          36067549
6  South America         400143568
</pre></div></div>
</div>
<p>We can see how Asia is the most populated country, followed by Africa. Antarctica is the least populated, as we would expect.</p>
<p>The code to aggregate has two main parts: - The <code class="docutils literal notranslate"><span class="pre">group_by</span></code> method, that receive the column, expression or list of them to group by - The <code class="docutils literal notranslate"><span class="pre">aggregate</span></code> method, that receives an expression with the reduction we want to apply</p>
<p>To make things a bit clearer, let’s first save the reduction.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">total_population</span> <span class="o">=</span> <span class="n">countries</span><span class="p">[</span><span class="s1">&#39;population&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s1">&#39;total_population&#39;</span><span class="p">)</span>
<span class="n">total_population</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
6878963738
</pre></div></div>
</div>
<p>As we can see, if we perform the operation directly, we will get the sum of the total in the column.</p>
<p>But if we take the <code class="docutils literal notranslate"><span class="pre">total_population</span></code> expression as the parameter of the <code class="docutils literal notranslate"><span class="pre">aggregate</span></code> method, then the total is computed over every group defined by the <code class="docutils literal notranslate"><span class="pre">group_by</span></code> method.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">countries</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">continent_name</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">total_population</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  continent_name  total_population
0         Africa        1021238685
1     Anctartica               170
2           Asia        4130584841
3         Europe         750724554
4  North America         540204371
5        Oceania          36067549
6  South America         400143568
</pre></div></div>
</div>
<p>If we want to compute two aggregates at the same time, we can pass a list to the <code class="docutils literal notranslate"><span class="pre">aggregate</span></code> method.</p>
<p>For illustration, we use the <code class="docutils literal notranslate"><span class="pre">continent</span></code> column, instead of the <code class="docutils literal notranslate"><span class="pre">continent_names</span></code> expression. We can use both column names and expressions, and also a list with any of them (e.g. <code class="docutils literal notranslate"><span class="pre">[continent_names,</span> <span class="pre">'name']</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">countries</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s1">&#39;continent&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">([</span><span class="n">total_population</span><span class="p">,</span>
                                           <span class="n">countries</span><span class="p">[</span><span class="s1">&#39;area_km2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s1">&#39;average_area&#39;</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  continent  total_population  average_area
0        AF        1021238685  5.234534e+05
1        AN               170  2.802439e+06
2        AS        4130584841  6.196685e+05
3        EU         750724554  4.293017e+05
4        NA         540204371  5.836313e+05
5        OC          36067549  3.044157e+05
6        SA         400143568  1.272751e+06
</pre></div></div>
</div>
</section>
<section id="Joining-data">
<h2>Joining data<a class="headerlink" href="#Joining-data" title="Permalink to this headline">¶</a></h2>
<p>Now we are going to get the total gross domestic product (GDP) for each continent. In this case, the GDP data is not in the same table <code class="docutils literal notranslate"><span class="pre">countries</span></code>, but in a table <code class="docutils literal notranslate"><span class="pre">gdp</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gdp</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;gdp&#39;</span><span class="p">)</span>
<span class="n">gdp</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
     country_code  year         value
0             ABW  1986  4.054634e+08
1             ABW  1987  4.876025e+08
2             ABW  1988  5.964236e+08
3             ABW  1989  6.953044e+08
4             ABW  1990  7.648871e+08
...           ...   ...           ...
9995          SVK  2002  3.513034e+10
9996          SVK  2003  4.681659e+10
9997          SVK  2004  5.733202e+10
9998          SVK  2005  6.278531e+10
9999          SVK  2006  7.070810e+10

[10000 rows x 3 columns]
</pre></div></div>
</div>
<p>The table contains information for different years, we can easily check the range with:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gdp</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">gdp</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1960, 2017)
</pre></div></div>
</div>
<p>Now, we are going to join this data with the <code class="docutils literal notranslate"><span class="pre">countries</span></code> table so we can obtain the continent of each country. The <code class="docutils literal notranslate"><span class="pre">countries</span></code> table has several different codes for the countries. Let’s find out which one matches the three letter code in the <code class="docutils literal notranslate"><span class="pre">gdp</span></code> table.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">countries</span><span class="p">[</span><span class="s1">&#39;iso_alpha2&#39;</span><span class="p">,</span> <span class="s1">&#39;iso_alpha3&#39;</span><span class="p">,</span> <span class="s1">&#39;iso_numeric&#39;</span><span class="p">,</span> <span class="s1">&#39;fips&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
    iso_alpha2 iso_alpha3  iso_numeric fips                  name
0           AD        AND           20   AN               Andorra
1           AE        ARE          784   AE  United Arab Emirates
2           AF        AFG            4   AF           Afghanistan
3           AG        ATG           28   AC   Antigua and Barbuda
4           AI        AIA          660   AV              Anguilla
..         ...        ...          ...  ...                   ...
247         YE        YEM          887   YM                 Yemen
248         YT        MYT          175   MF               Mayotte
249         ZA        ZAF          710   SF          South Africa
250         ZM        ZMB          894   ZA                Zambia
251         ZW        ZWE          716   ZI              Zimbabwe

[252 rows x 5 columns]
</pre></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">country_code</span></code> in <code class="docutils literal notranslate"><span class="pre">gdp</span></code> corresponds to <code class="docutils literal notranslate"><span class="pre">iso_alpha2</span></code> in the <code class="docutils literal notranslate"><span class="pre">countries</span></code> table. We can also see how the <code class="docutils literal notranslate"><span class="pre">gdp</span></code> table has <code class="docutils literal notranslate"><span class="pre">10,000</span></code> rows, while <code class="docutils literal notranslate"><span class="pre">countries</span></code> has <code class="docutils literal notranslate"><span class="pre">252</span></code>. We will start joining the two tables by the codes that match, discarding the codes that do not exist in both tables. This is called an inner join.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">countries_and_gdp</span> <span class="o">=</span> <span class="n">countries</span><span class="o">.</span><span class="n">inner_join</span><span class="p">(</span><span class="n">gdp</span><span class="p">,</span>
                                         <span class="n">predicates</span><span class="o">=</span><span class="n">countries</span><span class="p">[</span><span class="s1">&#39;iso_alpha3&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">gdp</span><span class="p">[</span><span class="s1">&#39;country_code&#39;</span><span class="p">])</span>
<span class="n">countries_and_gdp</span><span class="p">[</span><span class="n">countries</span><span class="p">,</span> <span class="n">gdp</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
     iso_alpha2 iso_alpha3  iso_numeric fips      name           capital  \
0            AD        AND           20   AN   Andorra  Andorra la Vella
1            AD        AND           20   AN   Andorra  Andorra la Vella
2            AD        AND           20   AN   Andorra  Andorra la Vella
3            AD        AND           20   AN   Andorra  Andorra la Vella
4            AD        AND           20   AN   Andorra  Andorra la Vella
...         ...        ...          ...  ...       ...               ...
9482         ZW        ZWE          716   ZI  Zimbabwe            Harare
9483         ZW        ZWE          716   ZI  Zimbabwe            Harare
9484         ZW        ZWE          716   ZI  Zimbabwe            Harare
9485         ZW        ZWE          716   ZI  Zimbabwe            Harare
9486         ZW        ZWE          716   ZI  Zimbabwe            Harare

      area_km2  population continent country_code  year         value
0        468.0       84000        EU          AND  1970  7.861921e+07
1        468.0       84000        EU          AND  1971  8.940982e+07
2        468.0       84000        EU          AND  1972  1.134082e+08
3        468.0       84000        EU          AND  1973  1.508201e+08
4        468.0       84000        EU          AND  1974  1.865587e+08
...        ...         ...       ...          ...   ...           ...
9482  390580.0    13061000        AF          ZWE  2013  1.909102e+10
9483  390580.0    13061000        AF          ZWE  2014  1.949552e+10
9484  390580.0    13061000        AF          ZWE  2015  1.996312e+10
9485  390580.0    13061000        AF          ZWE  2016  2.054868e+10
9486  390580.0    13061000        AF          ZWE  2017  2.281301e+10

[9487 rows x 12 columns]
</pre></div></div>
</div>
<p>We joined the table with the information for all years. Now we are going to just take the information about the last available year, 2017.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gdp_2017</span> <span class="o">=</span> <span class="n">gdp</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">gdp</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2017</span><span class="p">)</span>
<span class="n">gdp_2017</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
    country_code  year         value
0            ABW  2017  2.700559e+09
1            AFG  2017  2.019176e+10
2            AGO  2017  1.221238e+11
3            ALB  2017  1.302506e+10
4            AND  2017  3.013387e+09
..           ...   ...           ...
242          XKX  2017  7.227700e+09
243          YEM  2017  2.681870e+10
244          ZAF  2017  3.495541e+11
245          ZMB  2017  2.586814e+10
246          ZWE  2017  2.281301e+10

[247 rows x 3 columns]
</pre></div></div>
</div>
<p>Joining with the new expression we get:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">countries_and_gdp</span> <span class="o">=</span> <span class="n">countries</span><span class="o">.</span><span class="n">inner_join</span><span class="p">(</span><span class="n">gdp_2017</span><span class="p">,</span>
                                         <span class="n">predicates</span><span class="o">=</span><span class="n">countries</span><span class="p">[</span><span class="s1">&#39;iso_alpha3&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">gdp_2017</span><span class="p">[</span><span class="s1">&#39;country_code&#39;</span><span class="p">])</span>
<span class="n">countries_and_gdp</span><span class="p">[</span><span class="n">countries</span><span class="p">,</span> <span class="n">gdp_2017</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
    iso_alpha2 iso_alpha3  iso_numeric fips          name           capital  \
0           AW        ABW          533   AA         Aruba        Oranjestad
1           AF        AFG            4   AF   Afghanistan             Kabul
2           AO        AGO           24   AO        Angola            Luanda
3           AL        ALB            8   AL       Albania            Tirana
4           AD        AND           20   AN       Andorra  Andorra la Vella
..         ...        ...          ...  ...           ...               ...
196         XK        XKX            0   KV        Kosovo          Pristina
197         YE        YEM          887   YM         Yemen             Sanaa
198         ZA        ZAF          710   SF  South Africa          Pretoria
199         ZM        ZMB          894   ZA        Zambia            Lusaka
200         ZW        ZWE          716   ZI      Zimbabwe            Harare

      area_km2  population continent country_code  year         value
0        193.0       71566        NA          ABW  2017  2.700559e+09
1     647500.0    29121286        AS          AFG  2017  2.019176e+10
2    1246700.0    13068161        AF          AGO  2017  1.221238e+11
3      28748.0     2986952        EU          ALB  2017  1.302506e+10
4        468.0       84000        EU          AND  2017  3.013387e+09
..         ...         ...       ...          ...   ...           ...
196    10908.0     1800000        EU          XKX  2017  7.227700e+09
197   527970.0    23495361        AS          YEM  2017  2.681870e+10
198  1219912.0    49000000        AF          ZAF  2017  3.495541e+11
199   752614.0    13460305        AF          ZMB  2017  2.586814e+10
200   390580.0    13061000        AF          ZWE  2017  2.281301e+10

[201 rows x 12 columns]
</pre></div></div>
</div>
<p>We have called the <code class="docutils literal notranslate"><span class="pre">inner_join</span></code> method of the <code class="docutils literal notranslate"><span class="pre">countries</span></code> table and passed the <code class="docutils literal notranslate"><span class="pre">gdp</span></code> table as a parameter. The method receives a second parameter, <code class="docutils literal notranslate"><span class="pre">predicates</span></code>, that is used to specify how the join will be performed. In this case we want the <code class="docutils literal notranslate"><span class="pre">iso_alpha3</span></code> column in <code class="docutils literal notranslate"><span class="pre">countries</span></code> to match the <code class="docutils literal notranslate"><span class="pre">country_code</span></code> column in <code class="docutils literal notranslate"><span class="pre">gdp</span></code>. This is specified with the expression <code class="docutils literal notranslate"><span class="pre">countries['iso_alpha3']</span> <span class="pre">==</span> <span class="pre">gdp['country_code']</span></code>.</p>
<p>In the example <code class="docutils literal notranslate"><span class="pre">countries_and_gdp</span></code> is not an expression that can be executed directly. The result of a join can cause conflicts if both tables have column names in common. Before we can execute the query, we need to materialize the join, by calling the <code class="docutils literal notranslate"><span class="pre">.materialize()</span></code> method, or by selecting the columns to be returned.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="01-Introduction-to-Ibis.html" class="btn btn-neutral float-left" title="Introduction to Ibis" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="03-Expressions-Lazy-Mode-Logging.html" class="btn btn-neutral float-right" title="Expressions, lazy mode and logging queries" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Ibis Developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-65303298-2', 'auto');
  ga('send', 'pageview');

</script>


</body>
</html>