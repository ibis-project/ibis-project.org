
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>Ibis for SQL Programmers &#8212; Ibis 2.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/material.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="“Top-K” Filtering" href="topk.html" />
    <link rel="prev" title="Configuring Ibis" href="configuration.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=indigo data-md-color-accent=blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#user_guide/sql" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../index.html" title="Ibis 2.0.0 documentation"
           class="md-header-nav__button md-logo">
          
              <img src="../_static/logo-wide.svg" height="26"
                   alt="Ibis 2.0.0 documentation logo">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">Ibis 2.0.0 documentation</span>
          <span class="md-header-nav__topic"> Ibis for SQL Programmers </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
      
  
  <script src="../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../"versions.json"",
        target_loc = "../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="../index.html" class="md-tabs__link">Ibis 2.0.0 documentation</a></li>
          <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">User guide</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../index.html" title="Ibis 2.0.0 documentation" class="md-nav__button md-logo">
      
        <img src="../_static/logo-wide.svg" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../index.html"
       title="Ibis 2.0.0 documentation">Ibis 2.0.0 documentation</a>
  </label>
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
    
      <a href="../tutorial/index.html" class="md-nav__link">Tutorial</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="index.html" class="md-nav__link">User guide</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../api.html" class="md-nav__link">API Reference</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../backends/index.html" class="md-nav__link">Backends</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#user-guide-sql--page-root" class="md-nav__link">Ibis for SQL Programmers</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#projections-select-add-remove-columns" class="md-nav__link">Projections: select/add/remove columns</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#mutate-add-or-modify-columns-easily" class="md-nav__link"><code class="docutils literal notranslate"><span class="pre">mutate</span></code>: Add or modify columns easily</a>
        </li>
        <li class="md-nav__item"><a href="#select-equivalent" class="md-nav__link"><code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">*</span></code> equivalent</a>
        </li>
        <li class="md-nav__item"><a href="#using-functions-in-projections" class="md-nav__link">Using functions in projections</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#filtering-where" class="md-nav__link">Filtering / <code class="docutils literal notranslate"><span class="pre">WHERE</span></code></a>
        </li>
        <li class="md-nav__item"><a href="#aggregation-group-by" class="md-nav__link">Aggregation / <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code></a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#non-trivial-grouping-keys" class="md-nav__link">Non-trivial grouping keys</a>
        </li>
        <li class="md-nav__item"><a href="#aggregates-considering-table-subsets" class="md-nav__link">Aggregates considering table subsets</a>
        </li>
        <li class="md-nav__item"><a href="#count-convenience-size" class="md-nav__link"><code class="docutils literal notranslate"><span class="pre">count(*)</span></code> convenience: <code class="docutils literal notranslate"><span class="pre">size()</span></code></a>
        </li>
        <li class="md-nav__item"><a href="#frequency-table-convenience-value-counts" class="md-nav__link">Frequency table convenience: <code class="docutils literal notranslate"><span class="pre">value_counts</span></code></a>
        </li>
        <li class="md-nav__item"><a href="#having-clause" class="md-nav__link"><code class="docutils literal notranslate"><span class="pre">HAVING</span></code> clause</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#sorting-order-by" class="md-nav__link">Sorting / <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code></a>
        </li>
        <li class="md-nav__item"><a href="#limit-and-offset" class="md-nav__link"><code class="docutils literal notranslate"><span class="pre">LIMIT</span></code> and <code class="docutils literal notranslate"><span class="pre">OFFSET</span></code></a>
        </li>
        <li class="md-nav__item"><a href="#common-column-expressions" class="md-nav__link">Common column expressions</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#type-casts" class="md-nav__link">Type casts</a>
        </li>
        <li class="md-nav__item"><a href="#case-statements" class="md-nav__link"><code class="docutils literal notranslate"><span class="pre">CASE</span></code> statements</a>
        </li>
        <li class="md-nav__item"><a href="#using-null-in-expressions" class="md-nav__link">Using <code class="docutils literal notranslate"><span class="pre">NULL</span></code> in expressions</a>
        </li>
        <li class="md-nav__item"><a href="#set-membership-in-not-in" class="md-nav__link">Set membership: <code class="docutils literal notranslate"><span class="pre">IN</span></code> / <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">IN</span></code></a>
        </li>
        <li class="md-nav__item"><a href="#constant-and-literal-expressions" class="md-nav__link">Constant and literal expressions</a>
        </li>
        <li class="md-nav__item"><a href="#is-null-and-is-not-null" class="md-nav__link"><code class="docutils literal notranslate"><span class="pre">IS</span> <span class="pre">NULL</span></code> and <code class="docutils literal notranslate"><span class="pre">IS</span> <span class="pre">NOT</span> <span class="pre">NULL</span></code></a>
        </li>
        <li class="md-nav__item"><a href="#between" class="md-nav__link"><code class="docutils literal notranslate"><span class="pre">BETWEEN</span></code></a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#joins" class="md-nav__link">Joins</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#join-projection" class="md-nav__link">Join + projection</a>
        </li>
        <li class="md-nav__item"><a href="#join-aggregation" class="md-nav__link">Join + aggregation</a>
        </li>
        <li class="md-nav__item"><a href="#join-with-select" class="md-nav__link">Join with <code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">*</span></code></a>
        </li>
        <li class="md-nav__item"><a href="#multiple-joins" class="md-nav__link">Multiple joins</a>
        </li>
        <li class="md-nav__item"><a href="#self-joins" class="md-nav__link">Self joins</a>
        </li>
        <li class="md-nav__item"><a href="#overlapping-join-keys" class="md-nav__link">Overlapping join keys</a>
        </li>
        <li class="md-nav__item"><a href="#non-equality-join-predicates" class="md-nav__link">Non-equality join predicates</a>
        </li>
        <li class="md-nav__item"><a href="#other-ways-to-specify-join-keys" class="md-nav__link">Other ways to specify join keys</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#subqueries" class="md-nav__link">Subqueries</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#correlated-exists-not-exists-filters" class="md-nav__link">Correlated <code class="docutils literal notranslate"><span class="pre">EXISTS</span></code> / <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">EXISTS</span></code> filters</a>
        </li>
        <li class="md-nav__item"><a href="#subqueries-with-in-not-in" class="md-nav__link">Subqueries with <code class="docutils literal notranslate"><span class="pre">IN</span></code> / <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">IN</span></code></a>
        </li>
        <li class="md-nav__item"><a href="#comparison-with-scalar-aggregates" class="md-nav__link">Comparison with scalar aggregates</a>
        </li>
        <li class="md-nav__item"><a href="#conditional-aggregates" class="md-nav__link">Conditional aggregates</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#distinct-expressions" class="md-nav__link"><code class="docutils literal notranslate"><span class="pre">DISTINCT</span></code> expressions</a>
        </li>
        <li class="md-nav__item"><a href="#window-functions" class="md-nav__link">Window functions</a>
        </li>
        <li class="md-nav__item"><a href="#top-k-operations" class="md-nav__link">Top-K operations</a>
        </li>
        <li class="md-nav__item"><a href="#date-time-data" class="md-nav__link">Date / time data</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#casting-to-date-time-types" class="md-nav__link">Casting to date / time types</a>
        </li>
        <li class="md-nav__item"><a href="#timedeltas" class="md-nav__link">Timedeltas</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#buckets-and-histograms" class="md-nav__link">Buckets and histograms</a>
        </li>
        <li class="md-nav__item"><a href="#unions" class="md-nav__link">Unions</a>
        </li>
        <li class="md-nav__item"><a href="#esoterica" class="md-nav__link">Esoterica</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#common-table-expressions-ctes" class="md-nav__link">Common table expressions (CTEs)</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
    
<li class="md-nav__item"><a class="md-nav__extra_link" href="../_sources/user_guide/sql.rst.txt">Show Source</a> </li>

<li id="searchbox" class="md-nav__item"></li>

  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <section id="ibis-for-sql-programmers">
<span id="sql"></span><h1 id="user-guide-sql--page-root">Ibis for SQL Programmers<a class="headerlink" href="#user-guide-sql--page-root" title="Permalink to this headline">¶</a></h1>
<p>Among other things, Ibis provides a full-featured replacement for SQL
<code class="docutils literal notranslate"><span class="pre">SELECT</span></code> queries, but expressed with Python code that is:</p>
<ul class="simple">
<li><p>Type-checked and validated as you go. No more debugging cryptic database
errors; Ibis catches your mistakes right away.</p></li>
<li><p>Easier to write. Pythonic function calls with tab completion in IPython.</p></li>
<li><p>More composable. Break complex queries down into easier-to-digest pieces</p></li>
<li><p>Easier to reuse. Mix and match Ibis snippets to create expressions tailored
for your analysis.</p></li>
</ul>
<p>We intend for all <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> queries to be fully portable to Ibis. Coverage of
other DDL statements (e.g. <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span></code> or <code class="docutils literal notranslate"><span class="pre">INSERT</span></code>) may vary from
engine to engine.</p>
<p>This document will use the Impala SQL compiler (i.e. <code class="docutils literal notranslate"><span class="pre">ibis.impala.compile</span></code>)
for convenience, but the code here is portable to whichever system you are
using Ibis with.</p>
<blockquote>
<div><p><strong>Note</strong>: If you find any SQL idioms or use cases in your work that are not
represented here, please reach out so we can add more to this guide!</p>
</div></blockquote>
<section id="projections-select-add-remove-columns">
<h2 id="projections-select-add-remove-columns">Projections: select/add/remove columns<a class="headerlink" href="#projections-select-add-remove-columns" title="Permalink to this headline">¶</a></h2>
<p>All tables in Ibis are immutable. To select a subset of a table’s columns, or
to add new columns, you must produce a new table by means of a <em>projection</em>.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="n">t</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">table</span><span class="p">([(</span><span class="s1">'one'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
<span class="gp">   ...: </span>                <span class="p">(</span><span class="s1">'two'</span><span class="p">,</span> <span class="s1">'double'</span><span class="p">),</span>
<span class="gp">   ...: </span>                <span class="p">(</span><span class="s1">'three'</span><span class="p">,</span> <span class="s1">'int32'</span><span class="p">)],</span> <span class="s1">'my_data'</span><span class="p">)</span>
<span class="gp">   ...: </span>

<span class="gp">In [2]: </span><span class="n">t</span>
<span class="gh">Out[2]: </span><span class="go"></span>
<span class="go">UnboundTable[table]</span>
<span class="go">  name: my_data</span>
<span class="go">  schema:</span>
<span class="go">    one : string</span>
<span class="go">    two : float64</span>
<span class="go">    three : int32</span>
</pre></div>
</div>
<p>In SQL, you might write something like:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">two</span><span class="p">,</span><span class="w"> </span><span class="n">one</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">my_data</span><span class="w"></span>
</pre></div>
</div>
<p>In Ibis, this is</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [3]: </span><span class="n">proj</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">'two'</span><span class="p">,</span> <span class="s1">'one'</span><span class="p">]</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [4]: </span><span class="n">proj</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">projection</span><span class="p">([</span><span class="s1">'two'</span><span class="p">,</span> <span class="s1">'one'</span><span class="p">])</span>
</pre></div>
</div>
<p>This generates the expected SQL:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [5]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">proj</span><span class="p">))</span>
<span class="go">SELECT `two`, `one`</span>
<span class="go">FROM my_data</span>
</pre></div>
</div>
<p>What about adding new columns? To form a valid projection, all column
expressions must be <strong>named</strong>. Let’s look at the SQL:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">two</span><span class="p">,</span><span class="w"> </span><span class="n">one</span><span class="p">,</span><span class="w"> </span><span class="n">three</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">new_col</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">my_data</span><span class="w"></span>
</pre></div>
</div>
<p>The last expression is written:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [6]: </span><span class="n">new_col</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">three</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s1">'new_col'</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, we have:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [7]: </span><span class="n">proj</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">'two'</span><span class="p">,</span> <span class="s1">'one'</span><span class="p">,</span> <span class="n">new_col</span><span class="p">]</span>

<span class="gp">In [8]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">proj</span><span class="p">))</span>
<span class="go">SELECT `two`, `one`, `three` * 2 AS `new_col`</span>
<span class="go">FROM my_data</span>
</pre></div>
</div>
<section id="mutate-add-or-modify-columns-easily">
<h3 id="mutate-add-or-modify-columns-easily"><code class="docutils literal notranslate"><span class="pre">mutate</span></code>: Add or modify columns easily<a class="headerlink" href="#mutate-add-or-modify-columns-easily" title="Permalink to this headline">¶</a></h3>
<p>Since adding new columns or modifying existing columns is so common, there is a
convenience method <code class="docutils literal notranslate"><span class="pre">mutate</span></code>:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [9]: </span><span class="n">mutated</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">new_col</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">three</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that using the <code class="docutils literal notranslate"><span class="pre">name</span></code> was not necessary here because we’re using
Python keywords to provide the name. Indeed:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [10]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">mutated</span><span class="p">))</span>
<span class="go">SELECT *, `three` * 2 AS `new_col`</span>
<span class="go">FROM my_data</span>
</pre></div>
</div>
<p>If you modify an existing column with <code class="docutils literal notranslate"><span class="pre">mutate</span></code> it will list out all the other
columns:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [11]: </span><span class="n">mutated</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">two</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">two</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

<span class="gp">In [12]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">mutated</span><span class="p">))</span>
<span class="go">SELECT `one`, `two` * 2 AS `two`, `three`</span>
<span class="go">FROM my_data</span>
</pre></div>
</div>
</section>
<section id="select-equivalent">
<h3 id="select-equivalent"><code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">*</span></code> equivalent<a class="headerlink" href="#select-equivalent" title="Permalink to this headline">¶</a></h3>
<p>Especially in combination with relational joins, it’s convenient to be able to
select all columns in a table using the <code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">*</span></code> construct. To do this, use
the table expression itself in a projection:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [13]: </span><span class="n">proj</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

<span class="gp">In [14]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">proj</span><span class="p">))</span>
<span class="go">SELECT *</span>
<span class="go">FROM my_data</span>
</pre></div>
</div>
<p>This is how <code class="docutils literal notranslate"><span class="pre">mutate</span></code> is implemented. The example above
<code class="docutils literal notranslate"><span class="pre">t.mutate(new_col=t.three</span> <span class="pre">*</span> <span class="pre">2)</span></code> can be written as a normal projection:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [15]: </span><span class="n">proj</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">new_col</span><span class="p">]</span>

<span class="gp">In [16]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">proj</span><span class="p">))</span>
<span class="go">SELECT *, `three` * 2 AS `new_col`</span>
<span class="go">FROM my_data</span>
</pre></div>
</div>
<p>Let’s consider a table we might wish to join with <code class="docutils literal notranslate"><span class="pre">t</span></code>:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [17]: </span><span class="n">t2</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">table</span><span class="p">([(</span><span class="s1">'key'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
<span class="gp">   ....: </span>                 <span class="p">(</span><span class="s1">'value'</span><span class="p">,</span> <span class="s1">'double'</span><span class="p">)],</span> <span class="s1">'dim_table'</span><span class="p">)</span>
<span class="gp">   ....: </span>
</pre></div>
</div>
<p>Now let’s take the SQL:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">t0</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">.</span><span class="n">two</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">diff</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">my_data</span><span class="w"> </span><span class="n">t0</span><span class="w"></span>
<span class="w">  </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">dim_table</span><span class="w"> </span><span class="n">t1</span><span class="w"></span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">t0</span><span class="p">.</span><span class="n">one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="k">key</span><span class="w"></span>
</pre></div>
</div>
<p>To write this with Ibis, it is:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [18]: </span><span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">two</span> <span class="o">-</span> <span class="n">t2</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s1">'diff'</span><span class="p">)</span>

<span class="gp">In [19]: </span><span class="n">joined</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">one</span> <span class="o">==</span> <span class="n">t2</span><span class="o">.</span><span class="n">key</span><span class="p">)[</span><span class="n">t</span><span class="p">,</span> <span class="n">diff</span><span class="p">]</span>
</pre></div>
</div>
<p>And verify the generated SQL:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [20]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">joined</span><span class="p">))</span>
<span class="go">SELECT t0.*, t0.`two` - t1.`value` AS `diff`</span>
<span class="go">FROM my_data t0</span>
<span class="go">  INNER JOIN dim_table t1</span>
<span class="go">    ON t0.`one` = t1.`key`</span>
</pre></div>
</div>
</section>
<section id="using-functions-in-projections">
<h3 id="using-functions-in-projections">Using functions in projections<a class="headerlink" href="#using-functions-in-projections" title="Permalink to this headline">¶</a></h3>
<p>If you pass a function instead of a string or Ibis expression in any projection
context, it will be invoked with the “parent” table as its argument. This can
help significantly when <a class="reference external" href="http://blog.ibis-project.org/design-composability/">composing complex operations</a>. Consider this SQL:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">one</span><span class="p">,</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="k">abs</span><span class="p">(</span><span class="n">the_sum</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">mad</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">one</span><span class="p">,</span><span class="w"> </span><span class="n">three</span><span class="p">,</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">two</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">the_sum</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">my_data</span><span class="w"></span>
<span class="w">  </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span><span class="n">t0</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
</pre></div>
</div>
<p>This can be written as one chained expression:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [21]: </span><span class="n">expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">group_by</span><span class="p">([</span><span class="s1">'one'</span><span class="p">,</span> <span class="s1">'three'</span><span class="p">])</span>
<span class="gp">   ....: </span>        <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">the_sum</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">two</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="gp">   ....: </span>        <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s1">'one'</span><span class="p">)</span>
<span class="gp">   ....: </span>        <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">mad</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">the_sum</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
<span class="gp">   ....: </span>
</pre></div>
</div>
<p>Indeed:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [22]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT `one`, avg(abs(`the_sum`)) AS `mad`</span>
<span class="go">FROM (</span>
<span class="go">  SELECT `one`, `three`, sum(`two`) AS `the_sum`</span>
<span class="go">  FROM my_data</span>
<span class="go">  GROUP BY 1, 2</span>
<span class="go">) t0</span>
<span class="go">GROUP BY 1</span>
</pre></div>
</div>
</section>
</section>
<section id="filtering-where">
<h2 id="filtering-where">Filtering / <code class="docutils literal notranslate"><span class="pre">WHERE</span></code><a class="headerlink" href="#filtering-where" title="Permalink to this headline">¶</a></h2>
<p>You can add filter clauses to a table expression either by indexing with <code class="docutils literal notranslate"><span class="pre">[]</span></code>
(like pandas) or use the <code class="docutils literal notranslate"><span class="pre">filter</span></code> method:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [23]: </span><span class="n">filtered</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">two</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

<span class="gp">In [24]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">filtered</span><span class="p">))</span>
<span class="go">SELECT *</span>
<span class="go">FROM my_data</span>
<span class="go">WHERE `two` &gt; 0</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">filter</span></code> can take a list of expressions, which must all be satisfied for a
row to be included in the result:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [25]: </span><span class="n">filtered</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">filter</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">two</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
<span class="gp">   ....: </span>                     <span class="n">t</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">'A'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">])])</span>
<span class="gp">   ....: </span>

<span class="gp">In [26]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">filtered</span><span class="p">))</span>
<span class="go">SELECT *</span>
<span class="go">FROM my_data</span>
<span class="go">WHERE (`two` &gt; 0) AND</span>
<span class="go">      (`one` IN ('A', 'B'))</span>
</pre></div>
</div>
<p>To compose boolean expressions with <code class="docutils literal notranslate"><span class="pre">AND</span></code> or <code class="docutils literal notranslate"><span class="pre">OR</span></code>, use the respective <code class="docutils literal notranslate"><span class="pre">&amp;</span></code>
and <code class="docutils literal notranslate"><span class="pre">|</span></code> operators:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [27]: </span><span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">two</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">t</span><span class="o">.</span><span class="n">two</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">t</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">'A'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">]))</span>

<span class="gp">In [28]: </span><span class="n">filtered</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span>

<span class="gp">In [29]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">filtered</span><span class="p">))</span>
<span class="go">SELECT *</span>
<span class="go">FROM my_data</span>
<span class="go">WHERE (`two` &lt; 0) OR ((`two` &gt; 0) OR `one` IN ('A', 'B'))</span>
</pre></div>
</div>
</section>
<section id="aggregation-group-by">
<h2 id="aggregation-group-by">Aggregation / <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code><a class="headerlink" href="#aggregation-group-by" title="Permalink to this headline">¶</a></h2>
<p>To aggregate a table, you need:</p>
<ul class="simple">
<li><p>Zero or more grouping expressions (these can be column names)</p></li>
<li><p>One or more aggregation expressions</p></li>
</ul>
<p>Let’s look at the <code class="docutils literal notranslate"><span class="pre">aggregate</span></code> method on tables:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [30]: </span><span class="n">stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">two</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s1">'total_two'</span><span class="p">),</span>
<span class="gp">   ....: </span>         <span class="n">t</span><span class="o">.</span><span class="n">three</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s1">'avg_three'</span><span class="p">)]</span>
<span class="gp">   ....: </span>

<span class="gp">In [31]: </span><span class="n">agged</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</pre></div>
</div>
<p>If you don’t use any group expressions, the result will have a single row with
your statistics of interest:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [32]: </span><span class="n">agged</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span>
<span class="gh">Out[32]: </span><span class="go"></span>
<span class="go">ibis.Schema {  </span>
<span class="go">  total_two  float64</span>
<span class="go">  avg_three  float64</span>
<span class="go">}</span>

<span class="gp">In [33]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">agged</span><span class="p">))</span>
<span class="go">SELECT sum(`two`) AS `total_two`, avg(`three`) AS `avg_three`</span>
<span class="go">FROM my_data</span>
</pre></div>
</div>
<p>To add groupings, use either the <code class="docutils literal notranslate"><span class="pre">by</span></code> argument of <code class="docutils literal notranslate"><span class="pre">aggregate</span></code> or use the
<code class="docutils literal notranslate"><span class="pre">group_by</span></code> construct:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [34]: </span><span class="n">agged2</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s1">'one'</span><span class="p">)</span>

<span class="gp">In [35]: </span><span class="n">agged3</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s1">'one'</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>

<span class="gp">In [36]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">agged3</span><span class="p">))</span>
<span class="go">SELECT `one`, sum(`two`) AS `total_two`, avg(`three`) AS `avg_three`</span>
<span class="go">FROM my_data</span>
<span class="go">GROUP BY 1</span>
</pre></div>
</div>
<section id="non-trivial-grouping-keys">
<h3 id="non-trivial-grouping-keys">Non-trivial grouping keys<a class="headerlink" href="#non-trivial-grouping-keys" title="Permalink to this headline">¶</a></h3>
<p>You can use any expression (or function, like in projections) deriving from the
table you are aggregating. The only constraint is that the expressions must be
named. Let’s look at an example:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [37]: </span><span class="n">events</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">table</span><span class="p">([(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'timestamp'</span><span class="p">),</span>
<span class="gp">   ....: </span>                     <span class="p">(</span><span class="s1">'event_type'</span><span class="p">,</span> <span class="s1">'int32'</span><span class="p">),</span>
<span class="gp">   ....: </span>                     <span class="p">(</span><span class="s1">'session_id'</span><span class="p">,</span> <span class="s1">'int64'</span><span class="p">)],</span>
<span class="gp">   ....: </span>                     <span class="s1">'web_events'</span><span class="p">)</span>
<span class="gp">   ....: </span>
</pre></div>
</div>
<p>Suppose we wanted to total up event types by year and month:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [38]: </span><span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">events</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">year</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s1">'year'</span><span class="p">),</span>
<span class="gp">   ....: </span>        <span class="n">events</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">month</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s1">'month'</span><span class="p">)]</span>
<span class="gp">   ....: </span>

<span class="gp">In [39]: </span><span class="n">sessions</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">session_id</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>

<span class="gp">In [40]: </span><span class="n">stats</span> <span class="o">=</span> <span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
<span class="gp">   ....: </span>         <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">events</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
<span class="gp">   ....: </span>                    <span class="n">sessions</span><span class="o">=</span><span class="n">sessions</span><span class="p">))</span>
<span class="gp">   ....: </span>
</pre></div>
</div>
<p>Now we have:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [41]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">stats</span><span class="p">))</span>
<span class="go">SELECT extract(`ts`, 'year') AS `year`, extract(`ts`, 'month') AS `month`,</span>
<span class="go">       count(DISTINCT `session_id`) AS `sessions`, count(*) AS `total`</span>
<span class="go">FROM web_events</span>
<span class="go">GROUP BY 1, 2</span>
</pre></div>
</div>
</section>
<section id="aggregates-considering-table-subsets">
<span id="sql-aggregate-subsets"></span><h3 id="aggregates-considering-table-subsets">Aggregates considering table subsets<a class="headerlink" href="#aggregates-considering-table-subsets" title="Permalink to this headline">¶</a></h3>
<p>In analytics is it common to compare statistics from different subsets of a
table. Let’s consider a dataset containing people’s name, age, gender, and
nationality:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [42]: </span><span class="n">pop</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">table</span><span class="p">([(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
<span class="gp">   ....: </span>                  <span class="p">(</span><span class="s1">'country'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
<span class="gp">   ....: </span>                  <span class="p">(</span><span class="s1">'gender'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
<span class="gp">   ....: </span>                  <span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'int16'</span><span class="p">)],</span> <span class="s1">'population'</span><span class="p">)</span>
<span class="gp">   ....: </span>
</pre></div>
</div>
<p>Now, suppose you wanted to know for each country:</p>
<ul class="simple">
<li><p>Average overall age</p></li>
<li><p>Average male age</p></li>
<li><p>Average female age</p></li>
<li><p>Total number of persons</p></li>
</ul>
<p>In SQL, you may write:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">country</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_persons</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="k">AVG</span><span class="p">(</span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_age</span><span class="w"></span>
<span class="w">       </span><span class="k">AVG</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'M'</span><span class="w"></span>
<span class="w">             </span><span class="k">THEN</span><span class="w"> </span><span class="n">age</span><span class="w"></span>
<span class="w">             </span><span class="k">ELSE</span><span class="w"> </span><span class="k">NULL</span><span class="w"></span>
<span class="w">           </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_male</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="k">AVG</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'F'</span><span class="w"></span>
<span class="w">             </span><span class="k">THEN</span><span class="w"> </span><span class="n">age</span><span class="w"></span>
<span class="w">             </span><span class="k">ELSE</span><span class="w"> </span><span class="k">NULL</span><span class="w"></span>
<span class="w">           </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_female</span><span class="p">,</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">population</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
</pre></div>
</div>
<p>Ibis makes this much simpler by giving you <code class="docutils literal notranslate"><span class="pre">where</span></code> option in aggregation
functions:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [43]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">pop</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s1">'country'</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
<span class="gp">   ....: </span>   <span class="n">num_persons</span><span class="o">=</span><span class="n">pop</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
<span class="gp">   ....: </span>   <span class="n">avg_age</span><span class="o">=</span><span class="n">pop</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
<span class="gp">   ....: </span>   <span class="n">avg_male</span><span class="o">=</span><span class="n">pop</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">where</span><span class="o">=</span><span class="n">pop</span><span class="o">.</span><span class="n">gender</span> <span class="o">==</span> <span class="s1">'M'</span><span class="p">),</span>
<span class="gp">   ....: </span>   <span class="n">avg_female</span><span class="o">=</span><span class="n">pop</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">where</span><span class="o">=</span><span class="n">pop</span><span class="o">.</span><span class="n">gender</span> <span class="o">==</span> <span class="s1">'F'</span><span class="p">)</span>
<span class="gp">   ....: </span><span class="p">)</span>
<span class="gp">   ....: </span>
</pre></div>
</div>
<p>This indeed generates the correct SQL. Note that SQL engines handle <code class="docutils literal notranslate"><span class="pre">NULL</span></code>
values differently in aggregation functions, but Ibis will write the SQL
expression that is correct for your query engine.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [44]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT `country`, avg(`age`) AS `avg_age`,</span>
<span class="go">       avg(CASE WHEN `gender` = 'F' THEN `age` ELSE NULL END) AS `avg_female`,</span>
<span class="go">       avg(CASE WHEN `gender` = 'M' THEN `age` ELSE NULL END) AS `avg_male`,</span>
<span class="go">       count(*) AS `num_persons`</span>
<span class="go">FROM population</span>
<span class="go">GROUP BY 1</span>
</pre></div>
</div>
</section>
<section id="count-convenience-size">
<h3 id="count-convenience-size"><code class="docutils literal notranslate"><span class="pre">count(*)</span></code> convenience: <code class="docutils literal notranslate"><span class="pre">size()</span></code><a class="headerlink" href="#count-convenience-size" title="Permalink to this headline">¶</a></h3>
<p>Computing group frequencies is so common that, like pandas, we have a method
<code class="docutils literal notranslate"><span class="pre">size</span></code> that is a shortcut for the <code class="docutils literal notranslate"><span class="pre">count(*)</span></code> idiom:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [45]: </span><span class="n">freqs</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

<span class="gp">In [46]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">freqs</span><span class="p">))</span>
<span class="go">SELECT extract(`ts`, 'year') AS `year`, extract(`ts`, 'month') AS `month`,</span>
<span class="go">       count(*) AS `count`</span>
<span class="go">FROM web_events</span>
<span class="go">GROUP BY 1, 2</span>
</pre></div>
</div>
</section>
<section id="frequency-table-convenience-value-counts">
<h3 id="frequency-table-convenience-value-counts">Frequency table convenience: <code class="docutils literal notranslate"><span class="pre">value_counts</span></code><a class="headerlink" href="#frequency-table-convenience-value-counts" title="Permalink to this headline">¶</a></h3>
<p>Consider the SQL idiom:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">some_column_expression</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="k">table</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
</pre></div>
</div>
<p>This is so common that, like pandas, there is a generic array method
<code class="docutils literal notranslate"><span class="pre">value_counts</span></code> which does this for us:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [47]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">year</span><span class="p">()</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>

<span class="gp">In [48]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT extract(`ts`, 'year') AS `year`, count(*) AS `count`</span>
<span class="go">FROM web_events</span>
<span class="go">GROUP BY 1</span>
</pre></div>
</div>
</section>
<section id="having-clause">
<h3 id="having-clause"><code class="docutils literal notranslate"><span class="pre">HAVING</span></code> clause<a class="headerlink" href="#having-clause" title="Permalink to this headline">¶</a></h3>
<p>The SQL <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> clause enables you to filter the results of an aggregation
based on some group-wise condition holding true. For example, suppose we wanted
to limit our analysis to groups containing at least 1000 observations:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">one</span><span class="p">,</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">two</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">my_data</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="k">HAVING</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1000</span><span class="w"></span>
</pre></div>
</div>
<p>With Ibis, you can do:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [49]: </span><span class="n">expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s1">'one'</span><span class="p">)</span>
<span class="gp">   ....: </span>        <span class="o">.</span><span class="n">having</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span>
<span class="gp">   ....: </span>        <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">two</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s1">'total'</span><span class="p">)))</span>
<span class="gp">   ....: </span>

<span class="gp">In [50]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT `one`, sum(`two`) AS `total`</span>
<span class="go">FROM my_data</span>
<span class="go">GROUP BY 1</span>
<span class="go">HAVING count(*) &gt;= 1000</span>
</pre></div>
</div>
</section>
</section>
<section id="sorting-order-by">
<h2 id="sorting-order-by">Sorting / <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code><a class="headerlink" href="#sorting-order-by" title="Permalink to this headline">¶</a></h2>
<p>To sort a table, use the <code class="docutils literal notranslate"><span class="pre">sort_by</span></code> method along with either column names or
expressions that indicate the sorting keys:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [51]: </span><span class="nb">sorted</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">sort_by</span><span class="p">([</span><span class="n">events</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">year</span><span class="p">(),</span>
<span class="gp">   ....: </span>                         <span class="n">events</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">month</span><span class="p">()])</span>
<span class="gp">   ....: </span>

<span class="gp">In [52]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="nb">sorted</span><span class="p">))</span>
<span class="go">SELECT *</span>
<span class="go">FROM web_events</span>
<span class="go">ORDER BY extract(`ts`, 'year'), extract(`ts`, 'month')</span>
</pre></div>
</div>
<p>The default for sorting is in ascending order. To reverse the sort direction of
any key, either wrap it in <code class="docutils literal notranslate"><span class="pre">ibis.desc</span></code> or pass a tuple with <code class="docutils literal notranslate"><span class="pre">False</span></code> as the
second value:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [53]: </span><span class="nb">sorted</span> <span class="o">=</span> <span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">sort_by</span><span class="p">([</span><span class="n">ibis</span><span class="o">.</span><span class="n">desc</span><span class="p">(</span><span class="s1">'event_type'</span><span class="p">),</span>
<span class="gp">   ....: </span>                          <span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">month</span><span class="p">(),</span> <span class="kc">False</span><span class="p">)])</span>
<span class="gp">   ....: </span>          <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
<span class="gp">   ....: </span>

<span class="gp">In [54]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="nb">sorted</span><span class="p">))</span>
<span class="go">SELECT *</span>
<span class="go">FROM web_events</span>
<span class="go">ORDER BY `event_type` DESC, extract(`ts`, 'month') DESC</span>
<span class="go">LIMIT 100</span>
</pre></div>
</div>
</section>
<section id="limit-and-offset">
<h2 id="limit-and-offset"><code class="docutils literal notranslate"><span class="pre">LIMIT</span></code> and <code class="docutils literal notranslate"><span class="pre">OFFSET</span></code><a class="headerlink" href="#limit-and-offset" title="Permalink to this headline">¶</a></h2>
<p>This one is easy. The table <code class="docutils literal notranslate"><span class="pre">limit</span></code> function truncates a table to the
indicates number of rows. So if you only want the first 1000 rows (which may
not be deterministic depending on the SQL engine), you can do:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [55]: </span><span class="n">limited</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

<span class="gp">In [56]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">limited</span><span class="p">))</span>
<span class="go">SELECT *</span>
<span class="go">FROM my_data</span>
<span class="go">LIMIT 1000</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">offset</span></code> option in <code class="docutils literal notranslate"><span class="pre">limit</span></code> skips rows. So if you wanted rows 11 through
20, you could do:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [57]: </span><span class="n">limited</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="gp">In [58]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">limited</span><span class="p">))</span>
<span class="go">SELECT *</span>
<span class="go">FROM my_data</span>
<span class="go">LIMIT 10 OFFSET 10</span>
</pre></div>
</div>
</section>
<section id="common-column-expressions">
<h2 id="common-column-expressions">Common column expressions<a class="headerlink" href="#common-column-expressions" title="Permalink to this headline">¶</a></h2>
<p>See the full <a class="reference internal" href="../api.html#api"><span class="std std-ref">API documentation</span></a> for all of the available value
methods and tools for creating value expressions. We mention a few common ones
here as they relate to common SQL queries.</p>
<section id="type-casts">
<h3 id="type-casts">Type casts<a class="headerlink" href="#type-casts" title="Permalink to this headline">¶</a></h3>
<p>Ibis’s type system is independent of any SQL system. You cast Ibis expressions
from one Ibis type to another. For example:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [59]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">'timestamp'</span><span class="p">),</span>
<span class="gp">   ....: </span>                <span class="n">four</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">three</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">'double'</span><span class="p">))</span>
<span class="gp">   ....: </span>

<span class="gp">In [60]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *, CAST(`one` AS timestamp) AS `date`,</span>
<span class="go">       CAST(`three` AS double) AS `four`</span>
<span class="go">FROM my_data</span>
</pre></div>
</div>
</section>
<section id="case-statements">
<h3 id="case-statements"><code class="docutils literal notranslate"><span class="pre">CASE</span></code> statements<a class="headerlink" href="#case-statements" title="Permalink to this headline">¶</a></h3>
<p>SQL dialects typically support one or more kind of <code class="docutils literal notranslate"><span class="pre">CASE</span></code> statements. The
first is the <em>simple case</em> that compares against exact values of an expression.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CASE</span><span class="w"> </span><span class="n">expr</span><span class="w"></span>
<span class="w">  </span><span class="k">WHEN</span><span class="w"> </span><span class="n">value_1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">result_1</span><span class="w"></span>
<span class="w">  </span><span class="k">WHEN</span><span class="w"> </span><span class="n">value_2</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">result_2</span><span class="w"></span>
<span class="w">  </span><span class="k">ELSE</span><span class="w"> </span><span class="k">default</span><span class="w"></span>
<span class="k">END</span><span class="w"></span>
</pre></div>
</div>
<p>Value expressions in Ibis have a <code class="docutils literal notranslate"><span class="pre">case</span></code> method that allows us to emulate
these semantics:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [61]: </span><span class="n">case</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">'timestamp'</span><span class="p">)</span>
<span class="gp">   ....: </span>        <span class="o">.</span><span class="n">year</span><span class="p">()</span>
<span class="gp">   ....: </span>        <span class="o">.</span><span class="n">case</span><span class="p">()</span>
<span class="gp">   ....: </span>        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="s1">'This year'</span><span class="p">)</span>
<span class="gp">   ....: </span>        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="s1">'Last year'</span><span class="p">)</span>
<span class="gp">   ....: </span>        <span class="o">.</span><span class="n">else_</span><span class="p">(</span><span class="s1">'Earlier'</span><span class="p">)</span>
<span class="gp">   ....: </span>        <span class="o">.</span><span class="n">end</span><span class="p">())</span>
<span class="gp">   ....: </span>

<span class="gp">In [62]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">year_group</span><span class="o">=</span><span class="n">case</span><span class="p">)</span>

<span class="gp">In [63]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *,</span>
<span class="go">  CASE extract(CAST(`one` AS timestamp), 'year')</span>
<span class="go">    WHEN 2015 THEN 'This year'</span>
<span class="go">    WHEN 2014 THEN 'Last year'</span>
<span class="go">    ELSE 'Earlier'</span>
<span class="go">  END AS `year_group`</span>
<span class="go">FROM my_data</span>
</pre></div>
</div>
<p>The more general case is that of an arbitrary list of boolean expressions and
result values:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CASE</span><span class="w"></span>
<span class="w">  </span><span class="k">WHEN</span><span class="w"> </span><span class="n">boolean_expr1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">result_1</span><span class="w"></span>
<span class="w">  </span><span class="k">WHEN</span><span class="w"> </span><span class="n">boolean_expr2</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">result_2</span><span class="w"></span>
<span class="w">  </span><span class="k">WHEN</span><span class="w"> </span><span class="n">boolean_expr3</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">result_3</span><span class="w"></span>
<span class="w">  </span><span class="k">ELSE</span><span class="w"> </span><span class="k">default</span><span class="w"></span>
<span class="k">END</span><span class="w"></span>
</pre></div>
</div>
<p>To do this, use <code class="docutils literal notranslate"><span class="pre">ibis.case</span></code>:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [64]: </span><span class="n">case</span> <span class="o">=</span> <span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">case</span><span class="p">()</span>
<span class="gp">   ....: </span>        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">two</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">three</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">   ....: </span>        <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">two</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">three</span><span class="p">)</span>
<span class="gp">   ....: </span>        <span class="o">.</span><span class="n">else_</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">two</span><span class="p">)</span>
<span class="gp">   ....: </span>        <span class="o">.</span><span class="n">end</span><span class="p">())</span>
<span class="gp">   ....: </span>

<span class="gp">In [65]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">cond_value</span><span class="o">=</span><span class="n">case</span><span class="p">)</span>

<span class="gp">In [66]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *,</span>
<span class="go">  CASE</span>
<span class="go">    WHEN `two` &lt; 0 THEN `three` * 2</span>
<span class="go">    WHEN `two` &gt; 1 THEN `three`</span>
<span class="go">    ELSE `two`</span>
<span class="go">  END AS `cond_value`</span>
<span class="go">FROM my_data</span>
</pre></div>
</div>
<p>There are several places where Ibis builds cases for you in a simplified
way. One example is the <code class="docutils literal notranslate"><span class="pre">ifelse</span></code> function:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [67]: </span><span class="n">switch</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">two</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ifelse</span><span class="p">(</span><span class="s1">'Negative'</span><span class="p">,</span> <span class="s1">'Non-Negative'</span><span class="p">)</span>

<span class="gp">In [68]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">switch</span><span class="p">)</span>

<span class="gp">In [69]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *,</span>
<span class="go">       CASE WHEN `two` &lt; 0 THEN 'Negative' ELSE 'Non-Negative' END AS `group`</span>
<span class="go">FROM my_data</span>
</pre></div>
</div>
</section>
<section id="using-null-in-expressions">
<h3 id="using-null-in-expressions">Using <code class="docutils literal notranslate"><span class="pre">NULL</span></code> in expressions<a class="headerlink" href="#using-null-in-expressions" title="Permalink to this headline">¶</a></h3>
<p>To use <code class="docutils literal notranslate"><span class="pre">NULL</span></code> in an expression, either use the special <code class="docutils literal notranslate"><span class="pre">ibis.NA</span></code> value or
<code class="docutils literal notranslate"><span class="pre">ibis.null()</span></code>:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [70]: </span><span class="n">pos_two</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">two</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ifelse</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">two</span><span class="p">,</span> <span class="n">ibis</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span>

<span class="gp">In [71]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">two_positive</span><span class="o">=</span><span class="n">pos_two</span><span class="p">)</span>

<span class="gp">In [72]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *, CASE WHEN `two` &gt; 0 THEN `two` ELSE NULL END AS `two_positive`</span>
<span class="go">FROM my_data</span>
</pre></div>
</div>
</section>
<section id="set-membership-in-not-in">
<h3 id="set-membership-in-not-in">Set membership: <code class="docutils literal notranslate"><span class="pre">IN</span></code> / <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">IN</span></code><a class="headerlink" href="#set-membership-in-not-in" title="Permalink to this headline">¶</a></h3>
<p>Let’s look again at the population dataset. Suppose you wanted to combine the
United States and Canada data into a “North America” category. Here would be
some SQL to do it:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CASE</span><span class="w"></span>
<span class="w">  </span><span class="k">WHEN</span><span class="w"> </span><span class="k">upper</span><span class="p">(</span><span class="n">country</span><span class="p">)</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">'UNITED STATES'</span><span class="p">,</span><span class="w"> </span><span class="s1">'CANADA'</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">THEN</span><span class="w"> </span><span class="s1">'North America'</span><span class="w"></span>
<span class="w">  </span><span class="k">ELSE</span><span class="w"> </span><span class="n">country</span><span class="w"></span>
<span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">refined_group</span><span class="w"></span>
</pre></div>
</div>
<p>The Ibis equivalent of <code class="docutils literal notranslate"><span class="pre">IN</span></code> is the <code class="docutils literal notranslate"><span class="pre">isin</span></code> method. So we can write:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [73]: </span><span class="n">refined</span> <span class="o">=</span> <span class="p">(</span><span class="n">pop</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="gp">   ....: </span>           <span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">'UNITED STATES'</span><span class="p">,</span> <span class="s1">'CANADA'</span><span class="p">])</span>
<span class="gp">   ....: </span>           <span class="o">.</span><span class="n">ifelse</span><span class="p">(</span><span class="s1">'North America'</span><span class="p">,</span> <span class="n">pop</span><span class="o">.</span><span class="n">country</span><span class="p">))</span>
<span class="gp">   ....: </span>

<span class="gp">In [74]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">pop</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">refined_group</span><span class="o">=</span><span class="n">refined</span><span class="p">)</span>

<span class="gp">In [75]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *,</span>
<span class="go">       CASE WHEN upper(`country`) IN ('UNITED STATES', 'CANADA') THEN 'North America' ELSE `country` END AS `refined_group`</span>
<span class="go">FROM population</span>
</pre></div>
</div>
<p>The opposite of <code class="docutils literal notranslate"><span class="pre">isin</span></code> is <code class="docutils literal notranslate"><span class="pre">notin</span></code>.</p>
</section>
<section id="constant-and-literal-expressions">
<h3 id="constant-and-literal-expressions">Constant and literal expressions<a class="headerlink" href="#constant-and-literal-expressions" title="Permalink to this headline">¶</a></h3>
<p>Consider a SQL expression like:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="s1">'foo'</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="n">column1</span><span class="p">,</span><span class="w"> </span><span class="n">column2</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>which is equivalent to</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">column1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'foo'</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">column2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'foo'</span><span class="w"></span>
</pre></div>
</div>
<p>To build expressions off constant values, you must first convert the value
(whether a Python string or number) to an Ibis expression using
<code class="docutils literal notranslate"><span class="pre">ibis.literal</span></code>:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [76]: </span><span class="n">t3</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">table</span><span class="p">([(</span><span class="s1">'column1'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
<span class="gp">   ....: </span>                 <span class="p">(</span><span class="s1">'column2'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
<span class="gp">   ....: </span>                 <span class="p">(</span><span class="s1">'column3'</span><span class="p">,</span> <span class="s1">'double'</span><span class="p">)],</span> <span class="s1">'data'</span><span class="p">)</span>
<span class="gp">   ....: </span>

<span class="gp">In [77]: </span><span class="n">value</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)</span>
</pre></div>
</div>
<p>Once you’ve done this, you can use the literal expression like any other array
or scalar expression:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [78]: </span><span class="n">has_foo</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">t3</span><span class="o">.</span><span class="n">column1</span><span class="p">,</span> <span class="n">t3</span><span class="o">.</span><span class="n">column2</span><span class="p">])</span>

<span class="gp">In [79]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">t3</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">has_foo</span><span class="o">=</span><span class="n">has_foo</span><span class="p">)</span>

<span class="gp">In [80]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *, 'foo' IN (`column1`, `column2`) AS `has_foo`</span>
<span class="go">FROM `data`</span>
</pre></div>
</div>
<p>In many other situations, you can use constants without having to use
<code class="docutils literal notranslate"><span class="pre">ibis.literal</span></code>. For example, we could add a column containing nothing but the
number 5 like so:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [81]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">t3</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">number5</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="gp">In [82]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *, 5 AS `number5`</span>
<span class="go">FROM `data`</span>
</pre></div>
</div>
</section>
<section id="is-null-and-is-not-null">
<h3 id="is-null-and-is-not-null"><code class="docutils literal notranslate"><span class="pre">IS</span> <span class="pre">NULL</span></code> and <code class="docutils literal notranslate"><span class="pre">IS</span> <span class="pre">NOT</span> <span class="pre">NULL</span></code><a class="headerlink" href="#is-null-and-is-not-null" title="Permalink to this headline">¶</a></h3>
<p>These are simple: use the <code class="docutils literal notranslate"><span class="pre">isnull</span></code> and <code class="docutils literal notranslate"><span class="pre">notnull</span></code> functions respectively,
which yield boolean arrays:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [83]: </span><span class="n">indic</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">two</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">ifelse</span><span class="p">(</span><span class="s1">'valid'</span><span class="p">,</span> <span class="s1">'invalid'</span><span class="p">)</span>

<span class="gp">In [84]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">is_valid</span><span class="o">=</span><span class="n">indic</span><span class="p">)</span>

<span class="gp">In [85]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *,</span>
<span class="go">       CASE WHEN `two` IS NULL THEN 'valid' ELSE 'invalid' END AS `is_valid`</span>
<span class="go">FROM my_data</span>

<span class="gp">In [86]: </span><span class="n">agged</span> <span class="o">=</span> <span class="p">(</span><span class="n">expr</span>
<span class="gp">   ....: </span>         <span class="p">[</span><span class="n">expr</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>
<span class="gp">   ....: </span>         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s1">'is_valid'</span><span class="p">)</span>
<span class="gp">   ....: </span>         <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">three_count</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">three</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
<span class="gp">   ....: </span>

<span class="gp">In [87]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">agged</span><span class="p">))</span>
<span class="go">SELECT `is_valid`, sum(`three` IS NOT NULL) AS `three_count`</span>
<span class="go">FROM (</span>
<span class="go">  SELECT *,</span>
<span class="go">         CASE WHEN `two` IS NULL THEN 'valid' ELSE 'invalid' END AS `is_valid`</span>
<span class="go">  FROM my_data</span>
<span class="go">  WHERE `one` IS NOT NULL</span>
<span class="go">) t0</span>
<span class="go">GROUP BY 1</span>
</pre></div>
</div>
</section>
<section id="between">
<h3 id="between"><code class="docutils literal notranslate"><span class="pre">BETWEEN</span></code><a class="headerlink" href="#between" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">between</span></code> method on arrays and scalars compiles to the SQL <code class="docutils literal notranslate"><span class="pre">BETWEEN</span></code>
keyword. The result of <code class="docutils literal notranslate"><span class="pre">between</span></code> is boolean and can be used with any other
boolean expression:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [88]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">two</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">t</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>

<span class="gp">In [89]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *</span>
<span class="go">FROM my_data</span>
<span class="go">WHERE `two` BETWEEN 10 AND 50 AND (`one` IS NOT NULL)</span>
</pre></div>
</div>
</section>
</section>
<section id="joins">
<h2 id="joins">Joins<a class="headerlink" href="#joins" title="Permalink to this headline">¶</a></h2>
<p>Ibis supports several kinds of joins between table expressions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">inner_join</span></code>: maps to SQL <code class="docutils literal notranslate"><span class="pre">INNER</span> <span class="pre">JOIN</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cross_join</span></code>: a cartesian product join with no keys. Equivalent to
<code class="docutils literal notranslate"><span class="pre">inner_join</span></code> with no join predicates</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">left_join</span></code>: maps to SQL <code class="docutils literal notranslate"><span class="pre">LEFT</span> <span class="pre">OUTER</span> <span class="pre">JOIN</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">outer_join</span></code>: maps to SQL <code class="docutils literal notranslate"><span class="pre">FULL</span> <span class="pre">OUTER</span> <span class="pre">JOIN</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">semi_join</span></code>: maps to SQL <code class="docutils literal notranslate"><span class="pre">LEFT</span> <span class="pre">SEMI</span> <span class="pre">JOIN</span></code>. May or may not be an explicit
join type in your query engine.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anti_join</span></code>: maps to SQL <code class="docutils literal notranslate"><span class="pre">LEFT</span> <span class="pre">ANTI</span> <span class="pre">JOIN</span></code>. May or may not be an explicit
join type in your query engine.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">join</span></code> table method is by default the same as <code class="docutils literal notranslate"><span class="pre">inner_join</span></code>.</p>
<p>Let’s look at a couple example tables to see how joins work in Ibis:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [90]: </span><span class="n">t1</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">table</span><span class="p">([(</span><span class="s1">'value1'</span><span class="p">,</span> <span class="s1">'double'</span><span class="p">),</span>
<span class="gp">   ....: </span>                 <span class="p">(</span><span class="s1">'key1'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
<span class="gp">   ....: </span>                 <span class="p">(</span><span class="s1">'key2'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">)],</span> <span class="s1">'table1'</span><span class="p">)</span>
<span class="gp">   ....: </span>

<span class="gp">In [91]: </span><span class="n">t2</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">table</span><span class="p">([(</span><span class="s1">'value2'</span><span class="p">,</span> <span class="s1">'double'</span><span class="p">),</span>
<span class="gp">   ....: </span>                 <span class="p">(</span><span class="s1">'key3'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
<span class="gp">   ....: </span>                 <span class="p">(</span><span class="s1">'key4'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">)],</span> <span class="s1">'table2'</span><span class="p">)</span>
<span class="gp">   ....: </span>
</pre></div>
</div>
<p>Let’s join on one key:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [92]: </span><span class="n">joined</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">left_join</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">key1</span> <span class="o">==</span> <span class="n">t2</span><span class="o">.</span><span class="n">key3</span><span class="p">)</span>
</pre></div>
</div>
<p>The immediate result of a join does not yet have a set schema. That is
determined by the next action that you take. There’s several ways forward from
here that address the spectrum of SQL use cases.</p>
<section id="join-projection">
<h3 id="join-projection">Join + projection<a class="headerlink" href="#join-projection" title="Permalink to this headline">¶</a></h3>
<p>Consider the SQL:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">t0</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">value2</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">table1</span><span class="w"> </span><span class="n">t0</span><span class="w"></span>
<span class="w">  </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">table2</span><span class="w"> </span><span class="n">t1</span><span class="w"></span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">t0</span><span class="p">.</span><span class="n">key1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">key3</span><span class="w"></span>
</pre></div>
</div>
<p>After one or more joins, you can reference any of the joined tables in a
projection immediately after:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [93]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">joined</span><span class="p">[</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="o">.</span><span class="n">value2</span><span class="p">]</span>

<span class="gp">In [94]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT t0.*, t1.`value2`</span>
<span class="go">FROM table1 t0</span>
<span class="go">  LEFT OUTER JOIN table2 t1</span>
<span class="go">    ON t0.`key1` = t1.`key3`</span>
</pre></div>
</div>
<p>If you need to compute an expression that involves both tables, you can do that
also:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [95]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">joined</span><span class="p">[</span><span class="n">t1</span><span class="o">.</span><span class="n">key1</span><span class="p">,</span> <span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">value1</span> <span class="o">-</span> <span class="n">t2</span><span class="o">.</span><span class="n">value2</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s1">'diff'</span><span class="p">)]</span>

<span class="gp">In [96]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT t0.`key1`, t0.`value1` - t1.`value2` AS `diff`</span>
<span class="go">FROM table1 t0</span>
<span class="go">  LEFT OUTER JOIN table2 t1</span>
<span class="go">    ON t0.`key1` = t1.`key3`</span>
</pre></div>
</div>
</section>
<section id="join-aggregation">
<h3 id="join-aggregation">Join + aggregation<a class="headerlink" href="#join-aggregation" title="Permalink to this headline">¶</a></h3>
<p>You can directly aggregate a join without need for projection, which also
allows you to form statistics that reference any of the joined tables.</p>
<p>Consider this SQL:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">t0</span><span class="p">.</span><span class="n">key1</span><span class="p">,</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">t0</span><span class="p">.</span><span class="n">value1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">value2</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_diff</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">table1</span><span class="w"> </span><span class="n">t0</span><span class="w"></span>
<span class="w">  </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">table2</span><span class="w"> </span><span class="n">t1</span><span class="w"></span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">t0</span><span class="p">.</span><span class="n">key1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">key3</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
</pre></div>
</div>
<p>As you would hope, the code is as follows:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [97]: </span><span class="n">avg_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">value1</span> <span class="o">-</span> <span class="n">t2</span><span class="o">.</span><span class="n">value2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="gp">In [98]: </span><span class="n">expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">left_join</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">key1</span> <span class="o">==</span> <span class="n">t2</span><span class="o">.</span><span class="n">key3</span><span class="p">)</span>
<span class="gp">   ....: </span>        <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">key1</span><span class="p">)</span>
<span class="gp">   ....: </span>        <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">avg_diff</span><span class="o">=</span><span class="n">avg_diff</span><span class="p">))</span>
<span class="gp">   ....: </span>

<span class="gp">In [99]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT t0.`key1`, avg(t0.`value1` - t1.`value2`) AS `avg_diff`</span>
<span class="go">FROM table1 t0</span>
<span class="go">  LEFT OUTER JOIN table2 t1</span>
<span class="go">    ON t0.`key1` = t1.`key3`</span>
<span class="go">GROUP BY 1</span>
</pre></div>
</div>
</section>
<section id="join-with-select">
<h3 id="join-with-select">Join with <code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">*</span></code><a class="headerlink" href="#join-with-select" title="Permalink to this headline">¶</a></h3>
<p>If you try to compile or execute a join that has not been projected or
aggregated, it will be <em>fully materialized</em>:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [100]: </span><span class="n">joined</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">left_join</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">key1</span> <span class="o">==</span> <span class="n">t2</span><span class="o">.</span><span class="n">key3</span><span class="p">)</span>

<span class="gp">In [101]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">joined</span><span class="p">))</span>
<span class="go">SELECT *</span>
<span class="go">FROM table1 t0</span>
<span class="go">  LEFT OUTER JOIN table2 t1</span>
<span class="go">    ON t0.`key1` = t1.`key3`</span>
</pre></div>
</div>
<p>You can do this explicitly using the <code class="docutils literal notranslate"><span class="pre">materialize</span></code> method:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [102]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">materialize</span><span class="p">()</span>

<span class="gp">In [103]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *</span>
<span class="go">FROM table1 t0</span>
<span class="go">  LEFT OUTER JOIN table2 t1</span>
<span class="go">    ON t0.`key1` = t1.`key3`</span>
</pre></div>
</div>
</section>
<section id="multiple-joins">
<h3 id="multiple-joins">Multiple joins<a class="headerlink" href="#multiple-joins" title="Permalink to this headline">¶</a></h3>
<p>You can join multiple tables together in succession without needing to address
any of the above concerns.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [104]: </span><span class="n">t3</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">table</span><span class="p">([(</span><span class="s1">'value3'</span><span class="p">,</span> <span class="s1">'double'</span><span class="p">),</span>
<span class="gp">   .....: </span>                 <span class="p">(</span><span class="s1">'key5'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">)],</span> <span class="s1">'table3'</span><span class="p">)</span>
<span class="gp">   .....: </span>

<span class="gp">In [105]: </span><span class="n">total</span> <span class="o">=</span> <span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">value1</span> <span class="o">+</span> <span class="n">t2</span><span class="o">.</span><span class="n">value2</span> <span class="o">+</span> <span class="n">t3</span><span class="o">.</span><span class="n">value3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="gp">In [106]: </span><span class="n">expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="p">[</span><span class="n">t1</span><span class="o">.</span><span class="n">key1</span> <span class="o">==</span> <span class="n">t2</span><span class="o">.</span><span class="n">key3</span><span class="p">,</span>
<span class="gp">   .....: </span>                     <span class="n">t1</span><span class="o">.</span><span class="n">key2</span> <span class="o">==</span> <span class="n">t2</span><span class="o">.</span><span class="n">key4</span><span class="p">])</span>
<span class="gp">   .....: </span>        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">key1</span> <span class="o">==</span> <span class="n">t3</span><span class="o">.</span><span class="n">key5</span><span class="p">)</span>
<span class="gp">   .....: </span>        <span class="o">.</span><span class="n">group_by</span><span class="p">([</span><span class="n">t2</span><span class="o">.</span><span class="n">key4</span><span class="p">,</span> <span class="n">t3</span><span class="o">.</span><span class="n">key5</span><span class="p">])</span>
<span class="gp">   .....: </span>        <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">))</span>
<span class="gp">   .....: </span>

<span class="gp">In [107]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT t1.`key4`, t2.`key5`,</span>
<span class="go">       sum((t0.`value1` + t1.`value2`) + t2.`value3`) AS `total`</span>
<span class="go">FROM table1 t0</span>
<span class="go">  INNER JOIN table2 t1</span>
<span class="go">    ON (t0.`key1` = t1.`key3`) AND</span>
<span class="go">       (t0.`key2` = t1.`key4`)</span>
<span class="go">  INNER JOIN table3 t2</span>
<span class="go">    ON t0.`key1` = t2.`key5`</span>
<span class="go">GROUP BY 1, 2</span>
</pre></div>
</div>
</section>
<section id="self-joins">
<h3 id="self-joins">Self joins<a class="headerlink" href="#self-joins" title="Permalink to this headline">¶</a></h3>
<p>What about when you need to join a table on itself? For example:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">t0</span><span class="p">.</span><span class="n">one</span><span class="p">,</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">t0</span><span class="p">.</span><span class="n">two</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">three</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">metric</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">my_data</span><span class="w"> </span><span class="n">t0</span><span class="w"></span>
<span class="w">  </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">my_data</span><span class="w"> </span><span class="n">t1</span><span class="w"></span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">t0</span><span class="p">.</span><span class="n">one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">one</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
</pre></div>
</div>
<p>The table <code class="docutils literal notranslate"><span class="pre">view</span></code> method enables you to form a <em>self-reference</em> that is
referentially distinct in expressions. Now you can proceed normally:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [108]: </span><span class="n">t_view</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>

<span class="gp">In [109]: </span><span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">two</span> <span class="o">-</span> <span class="n">t_view</span><span class="o">.</span><span class="n">three</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="gp">In [110]: </span><span class="n">expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t_view</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">three</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">'string'</span><span class="p">)</span> <span class="o">==</span> <span class="n">t_view</span><span class="o">.</span><span class="n">one</span><span class="p">)</span>
<span class="gp">   .....: </span>        <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">one</span><span class="p">)</span>
<span class="gp">   .....: </span>        <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="n">stat</span><span class="p">))</span>
<span class="gp">   .....: </span>

<span class="gp">In [111]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT t0.`one`, avg(t0.`two` - t1.`three`) AS `metric`</span>
<span class="go">FROM my_data t0</span>
<span class="go">  INNER JOIN my_data t1</span>
<span class="go">    ON CAST(t0.`three` AS string) = t1.`one`</span>
<span class="go">GROUP BY 1</span>
</pre></div>
</div>
</section>
<section id="overlapping-join-keys">
<h3 id="overlapping-join-keys">Overlapping join keys<a class="headerlink" href="#overlapping-join-keys" title="Permalink to this headline">¶</a></h3>
<p>In many cases the columns being joined between two tables or table expressions
have the same name. Consider this example:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [112]: </span><span class="n">t4</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">table</span><span class="p">([(</span><span class="s1">'key1'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
<span class="gp">   .....: </span>                 <span class="p">(</span><span class="s1">'key2'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
<span class="gp">   .....: </span>                 <span class="p">(</span><span class="s1">'key3'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
<span class="gp">   .....: </span>                 <span class="p">(</span><span class="s1">'value1'</span><span class="p">,</span> <span class="s1">'double'</span><span class="p">)],</span> <span class="s1">'table4'</span><span class="p">)</span>
<span class="gp">   .....: </span>

<span class="gp">In [113]: </span><span class="n">t5</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">table</span><span class="p">([(</span><span class="s1">'key1'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
<span class="gp">   .....: </span>                 <span class="p">(</span><span class="s1">'key2'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
<span class="gp">   .....: </span>                 <span class="p">(</span><span class="s1">'key3'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
<span class="gp">   .....: </span>                 <span class="p">(</span><span class="s1">'value2'</span><span class="p">,</span> <span class="s1">'double'</span><span class="p">)],</span> <span class="s1">'table5'</span><span class="p">)</span>
<span class="gp">   .....: </span>
</pre></div>
</div>
<p>In these case, we can specify a list of common join keys:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [114]: </span><span class="n">joined</span> <span class="o">=</span> <span class="n">t4</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t5</span><span class="p">,</span> <span class="p">[</span><span class="s1">'key1'</span><span class="p">,</span> <span class="s1">'key2'</span><span class="p">,</span> <span class="s1">'key3'</span><span class="p">])</span>

<span class="gp">In [115]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">joined</span><span class="p">[</span><span class="n">t4</span><span class="p">,</span> <span class="n">t5</span><span class="o">.</span><span class="n">value2</span><span class="p">]</span>

<span class="gp">In [116]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT t0.*, t1.`value2`</span>
<span class="go">FROM table4 t0</span>
<span class="go">  INNER JOIN table5 t1</span>
<span class="go">    ON (t0.`key1` = t1.`key1`) AND</span>
<span class="go">       (t0.`key2` = t1.`key2`) AND</span>
<span class="go">       (t0.`key3` = t1.`key3`)</span>
</pre></div>
</div>
<p>You can mix the overlapping key names with other expressions:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [117]: </span><span class="n">joined</span> <span class="o">=</span> <span class="n">t4</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t5</span><span class="p">,</span> <span class="p">[</span><span class="s1">'key1'</span><span class="p">,</span> <span class="s1">'key2'</span><span class="p">,</span>
<span class="gp">   .....: </span>                      <span class="n">t4</span><span class="o">.</span><span class="n">key3</span><span class="o">.</span><span class="n">left</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="n">t4</span><span class="o">.</span><span class="n">key3</span><span class="o">.</span><span class="n">left</span><span class="p">(</span><span class="mi">4</span><span class="p">)])</span>
<span class="gp">   .....: </span>

<span class="gp">In [118]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">joined</span><span class="p">[</span><span class="n">t4</span><span class="p">,</span> <span class="n">t5</span><span class="o">.</span><span class="n">value2</span><span class="p">]</span>

<span class="gp">In [119]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT t0.*, t1.`value2`</span>
<span class="go">FROM table4 t0</span>
<span class="go">  INNER JOIN table5 t1</span>
<span class="go">    ON (t0.`key1` = t1.`key1`) AND</span>
<span class="go">       (t0.`key2` = t1.`key2`) AND</span>
<span class="go">       (substr(t0.`key3`, 0 + 1, 4) = substr(t0.`key3`, 0 + 1, 4))</span>
</pre></div>
</div>
</section>
<section id="non-equality-join-predicates">
<h3 id="non-equality-join-predicates">Non-equality join predicates<a class="headerlink" href="#non-equality-join-predicates" title="Permalink to this headline">¶</a></h3>
<p>You can join tables with boolean clauses that are not equality. Some query
engines support these efficiently, some inefficiently, or some not at all. In
the latter case, these conditions get moved by Ibis into the <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> part of
the <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> query.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [120]: </span><span class="n">expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">value1</span> <span class="o">&lt;</span> <span class="n">t2</span><span class="o">.</span><span class="n">value2</span><span class="p">)</span>
<span class="gp">   .....: </span>        <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">key1</span><span class="p">)</span>
<span class="gp">   .....: </span>        <span class="o">.</span><span class="n">size</span><span class="p">())</span>
<span class="gp">   .....: </span>

<span class="gp">In [121]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT t0.`key1`, count(*) AS `count`</span>
<span class="go">FROM table1 t0</span>
<span class="go">  INNER JOIN table2 t1</span>
<span class="go">    ON t0.`value1` &lt; t1.`value2`</span>
<span class="go">GROUP BY 1</span>
</pre></div>
</div>
</section>
<section id="other-ways-to-specify-join-keys">
<h3 id="other-ways-to-specify-join-keys">Other ways to specify join keys<a class="headerlink" href="#other-ways-to-specify-join-keys" title="Permalink to this headline">¶</a></h3>
<p>You can also pass a list of column names instead of forming boolean expressions:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [122]: </span><span class="n">joined</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="p">[(</span><span class="s1">'key1'</span><span class="p">,</span> <span class="s1">'key3'</span><span class="p">),</span>
<span class="gp">   .....: </span>                      <span class="p">(</span><span class="s1">'key2'</span><span class="p">,</span> <span class="s1">'key4'</span><span class="p">)])</span>
<span class="gp">   .....: </span>
</pre></div>
</div>
</section>
</section>
<section id="subqueries">
<h2 id="subqueries">Subqueries<a class="headerlink" href="#subqueries" title="Permalink to this headline">¶</a></h2>
<p>Ibis creates inline views and nested subqueries automatically. This section
concerns more complex subqueries involving foreign references and other
advanced relational algebra.</p>
<section id="correlated-exists-not-exists-filters">
<h3 id="correlated-exists-not-exists-filters">Correlated <code class="docutils literal notranslate"><span class="pre">EXISTS</span></code> / <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">EXISTS</span></code> filters<a class="headerlink" href="#correlated-exists-not-exists-filters" title="Permalink to this headline">¶</a></h3>
<p>The SQL <code class="docutils literal notranslate"><span class="pre">EXISTS</span></code> and <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">EXISTS</span></code> constructs are typically used for
efficient filtering in large many-to-many relationships.</p>
<p>Let’s consider a web dataset involving website session / usage data and
purchases:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [123]: </span><span class="n">events</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">table</span><span class="p">([(</span><span class="s1">'session_id'</span><span class="p">,</span> <span class="s1">'int64'</span><span class="p">),</span>
<span class="gp">   .....: </span>                     <span class="p">(</span><span class="s1">'user_id'</span><span class="p">,</span> <span class="s1">'int64'</span><span class="p">),</span>
<span class="gp">   .....: </span>                     <span class="p">(</span><span class="s1">'event_type'</span><span class="p">,</span> <span class="s1">'int32'</span><span class="p">),</span>
<span class="gp">   .....: </span>                     <span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'timestamp'</span><span class="p">)],</span> <span class="s1">'events'</span><span class="p">)</span>
<span class="gp">   .....: </span>

<span class="gp">In [124]: </span><span class="n">purchases</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">table</span><span class="p">([(</span><span class="s1">'item_id'</span><span class="p">,</span> <span class="s1">'int64'</span><span class="p">),</span>
<span class="gp">   .....: </span>                        <span class="p">(</span><span class="s1">'user_id'</span><span class="p">,</span> <span class="s1">'int64'</span><span class="p">),</span>
<span class="gp">   .....: </span>                        <span class="p">(</span><span class="s1">'price'</span><span class="p">,</span> <span class="s1">'double'</span><span class="p">),</span>
<span class="gp">   .....: </span>                        <span class="p">(</span><span class="s1">'ts'</span><span class="p">,</span> <span class="s1">'timestamp'</span><span class="p">)],</span> <span class="s1">'purchases'</span><span class="p">)</span>
<span class="gp">   .....: </span>
</pre></div>
</div>
<p>Now, the key <code class="docutils literal notranslate"><span class="pre">user_id</span></code> appears with high frequency in both tables. But let’s
say you want to limit your analysis of the <code class="docutils literal notranslate"><span class="pre">events</span></code> table to only sessions by
users who have made a purchase.</p>
<p>In SQL, you can do this using the somewhat esoteric <code class="docutils literal notranslate"><span class="pre">EXISTS</span></code> construct:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">t0</span><span class="p">.</span><span class="o">*</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">events</span><span class="w"> </span><span class="n">t0</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">purchases</span><span class="w"> </span><span class="n">t1</span><span class="w"></span>
<span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">t0</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">user_id</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>To describe this operation in Ibis, you compare the <code class="docutils literal notranslate"><span class="pre">user_id</span></code> columns and use
the <code class="docutils literal notranslate"><span class="pre">any</span></code> reduction:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [125]: </span><span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">purchases</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
</pre></div>
</div>
<p>This can now be used to filter <code class="docutils literal notranslate"><span class="pre">events</span></code>:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [126]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span>

<span class="gp">In [127]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT t0.*</span>
<span class="go">FROM events t0</span>
<span class="go">WHERE EXISTS (</span>
<span class="go">  SELECT 1</span>
<span class="go">  FROM purchases t1</span>
<span class="go">  WHERE t0.`user_id` = t1.`user_id`</span>
<span class="go">)</span>
</pre></div>
</div>
<p>If you negate the condition, it will instead give you only event data from user
<em>that have not made a purchase</em>:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [128]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="n">cond</span><span class="p">]</span>

<span class="gp">In [129]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT t0.*</span>
<span class="go">FROM events t0</span>
<span class="go">WHERE NOT EXISTS (</span>
<span class="go">  SELECT 1</span>
<span class="go">  FROM purchases t1</span>
<span class="go">  WHERE t0.`user_id` = t1.`user_id`</span>
<span class="go">)</span>
</pre></div>
</div>
</section>
<section id="subqueries-with-in-not-in">
<h3 id="subqueries-with-in-not-in">Subqueries with <code class="docutils literal notranslate"><span class="pre">IN</span></code> / <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">IN</span></code><a class="headerlink" href="#subqueries-with-in-not-in" title="Permalink to this headline">¶</a></h3>
<p>Subquery filters with <code class="docutils literal notranslate"><span class="pre">IN</span></code> (and <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">IN</span></code>) are functionally similar to
<code class="docutils literal notranslate"><span class="pre">EXISTS</span></code> subqueries. Let’s look at some SQL:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">events</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">user_id</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">purchases</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>This is almost semantically the same as the <code class="docutils literal notranslate"><span class="pre">EXISTS</span></code> example. Indeed, you can
write with Ibis:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [130]: </span><span class="n">cond</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">purchases</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>

<span class="gp">In [131]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span>

<span class="gp">In [132]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *</span>
<span class="go">FROM events</span>
<span class="go">WHERE `user_id` IN (</span>
<span class="go">  SELECT `user_id`</span>
<span class="go">  FROM purchases</span>
<span class="go">)</span>
</pre></div>
</div>
<p>Depending on the query engine, the query planner/optimizer will often rewrite
<code class="docutils literal notranslate"><span class="pre">IN</span></code> or <code class="docutils literal notranslate"><span class="pre">EXISTS</span></code> subqueries into the same set of relational algebra
operations.</p>
</section>
<section id="comparison-with-scalar-aggregates">
<h3 id="comparison-with-scalar-aggregates">Comparison with scalar aggregates<a class="headerlink" href="#comparison-with-scalar-aggregates" title="Permalink to this headline">¶</a></h3>
<p>Sometime you want to compare a value with an unconditional aggregate value from
a different table. Take the SQL:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">table1</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">value1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">value2</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">table2</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>With Ibis, the code is simpler and more pandas-like:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [133]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">t1</span><span class="p">[</span><span class="n">t1</span><span class="o">.</span><span class="n">value1</span> <span class="o">&gt;</span> <span class="n">t2</span><span class="o">.</span><span class="n">value2</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>

<span class="gp">In [134]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *</span>
<span class="go">FROM table1</span>
<span class="go">WHERE `value1` &gt; (</span>
<span class="go">  SELECT max(`value2`) AS `max`</span>
<span class="go">  FROM table2</span>
<span class="go">)</span>
</pre></div>
</div>
</section>
<section id="conditional-aggregates">
<h3 id="conditional-aggregates">Conditional aggregates<a class="headerlink" href="#conditional-aggregates" title="Permalink to this headline">¶</a></h3>
<p>Suppose you want to compare a value with the aggregate value for some common
group values between two tables. Here’s some SQL:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">table1</span><span class="w"> </span><span class="n">t0</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">value1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">value2</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">table2</span><span class="w"> </span><span class="n">t1</span><span class="w"></span>
<span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">t0</span><span class="p">.</span><span class="n">key1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">key3</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>This query computes the average for each distinct value of <code class="docutils literal notranslate"><span class="pre">key3</span></code> and uses
the corresponding average for the comparison, rather than the whole-table
average as above.</p>
<p>With Ibis, the code is similar, but you add the correlated filter to the
average statistic:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [135]: </span><span class="n">stat</span> <span class="o">=</span> <span class="n">t2</span><span class="p">[</span><span class="n">t1</span><span class="o">.</span><span class="n">key1</span> <span class="o">==</span> <span class="n">t2</span><span class="o">.</span><span class="n">key3</span><span class="p">]</span><span class="o">.</span><span class="n">value2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="gp">In [136]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">t1</span><span class="p">[</span><span class="n">t1</span><span class="o">.</span><span class="n">value1</span> <span class="o">&gt;</span> <span class="n">stat</span><span class="p">]</span>

<span class="gp">In [137]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT t0.*</span>
<span class="go">FROM table1 t0</span>
<span class="go">WHERE t0.`value1` &gt; (</span>
<span class="go">  SELECT avg(t1.`value2`) AS `mean`</span>
<span class="go">  FROM table2 t1</span>
<span class="go">  WHERE t0.`key1` = t1.`key3`</span>
<span class="go">)</span>
</pre></div>
</div>
</section>
</section>
<section id="distinct-expressions">
<h2 id="distinct-expressions"><code class="docutils literal notranslate"><span class="pre">DISTINCT</span></code> expressions<a class="headerlink" href="#distinct-expressions" title="Permalink to this headline">¶</a></h2>
<p>In SQL, the <code class="docutils literal notranslate"><span class="pre">DISTINCT</span></code> keyword is used in a couple of ways:</p>
<ul class="simple">
<li><p>Deduplicating identical rows in some <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> statement</p></li>
<li><p>Aggregating on the distinct values of some column expression</p></li>
</ul>
<p>Ibis supports both use cases. So let’s have a look. The first case is the
simplest: call <code class="docutils literal notranslate"><span class="pre">distinct</span></code> on a table expression. First, here’s the SQL:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">table1</span><span class="w"></span>
</pre></div>
</div>
<p>And the Ibis Python code:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [138]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>

<span class="gp">In [139]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT DISTINCT *</span>
<span class="go">FROM table1</span>
</pre></div>
</div>
<p>For distinct aggregates, the most common case is <code class="docutils literal notranslate"><span class="pre">COUNT(DISTINCT</span> <span class="pre">...)</span></code>, which
computes the number of unique values in an expression. So if we’re looking at
the <code class="docutils literal notranslate"><span class="pre">events</span></code> table, let’s compute the number of distinct <code class="docutils literal notranslate"><span class="pre">event_type</span></code>
values for each <code class="docutils literal notranslate"><span class="pre">user_id</span></code>. First, the SQL:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">event_type</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">unique_events</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">events</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
</pre></div>
</div>
<p>In Ibis this is:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [140]: </span><span class="n">metric</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">event_type</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>

<span class="gp">In [141]: </span><span class="n">expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s1">'user_id'</span><span class="p">)</span>
<span class="gp">   .....: </span>        <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">unique_events</span><span class="o">=</span><span class="n">metric</span><span class="p">))</span>
<span class="gp">   .....: </span>

<span class="gp">In [142]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT `user_id`, count(DISTINCT `event_type`) AS `unique_events`</span>
<span class="go">FROM events</span>
<span class="go">GROUP BY 1</span>
</pre></div>
</div>
</section>
<section id="window-functions">
<h2 id="window-functions">Window functions<a class="headerlink" href="#window-functions" title="Permalink to this headline">¶</a></h2>
<p>Window functions in SQL allow you to write expressions that involve
possibly-ordered groups of a table. Each window function involves one of the
following:</p>
<ul class="simple">
<li><p>An analytic function. Most aggregate functions are valid analytic functions,
and there are additional ones such as <code class="docutils literal notranslate"><span class="pre">LEAD</span></code>, <code class="docutils literal notranslate"><span class="pre">LAG</span></code>, <code class="docutils literal notranslate"><span class="pre">NTILE</span></code>, and
others.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">PARTITION</span> <span class="pre">BY</span></code> clause. This may be omitted.</p></li>
<li><p>An <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code> clause. This may be omitted for many functions.</p></li>
<li><p>A window frame clause. The default is to use the entire partition.</p></li>
</ul>
<p>So you may see SQL like:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">AVG</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">key1</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Or simply</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">AVG</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
</pre></div>
</div>
<p>Ibis will automatically write window clauses when you use aggregate functions
in a non-aggregate context. Suppose you wanted to subtract the mean of a column
from itself:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [143]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">two_demean</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">two</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">two</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="gp">In [144]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *, `two` - avg(`two`) OVER () AS `two_demean`</span>
<span class="go">FROM my_data</span>
</pre></div>
</div>
<p>If you use <code class="docutils literal notranslate"><span class="pre">mutate</span></code> in conjunction with <code class="docutils literal notranslate"><span class="pre">group_by</span></code>, it will add a
<code class="docutils literal notranslate"><span class="pre">PARTITION</span> <span class="pre">BY</span></code> to the <code class="docutils literal notranslate"><span class="pre">OVER</span></code> specification:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [145]: </span><span class="n">expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s1">'one'</span><span class="p">)</span>
<span class="gp">   .....: </span>        <span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">two_demean</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">two</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">two</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
<span class="gp">   .....: </span>

<span class="gp">In [146]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *, `two` - avg(`two`) OVER (PARTITION BY `one`) AS `two_demean`</span>
<span class="go">FROM my_data</span>
</pre></div>
</div>
<p>For functions like <code class="docutils literal notranslate"><span class="pre">LAG</span></code> that require an ordering, we can add an <code class="docutils literal notranslate"><span class="pre">order_by</span></code>
call:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [147]: </span><span class="n">expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s1">'one'</span><span class="p">)</span>
<span class="gp">   .....: </span>        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">two</span><span class="p">)</span>
<span class="gp">   .....: </span>        <span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">two_first_diff</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">two</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">two</span><span class="o">.</span><span class="n">lag</span><span class="p">()))</span>
<span class="gp">   .....: </span>

<span class="gp">In [148]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *,</span>
<span class="go">       `two` - lag(`two`) OVER (PARTITION BY `one` ORDER BY `two`) AS `two_first_diff`</span>
<span class="go">FROM my_data</span>
</pre></div>
</div>
<p>For more precision, you can create a <code class="docutils literal notranslate"><span class="pre">Window</span></code> object that also includes a
window frame clause:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [149]: </span><span class="n">w</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">window</span><span class="p">(</span><span class="n">group_by</span><span class="o">=</span><span class="s1">'one'</span><span class="p">,</span> <span class="n">preceding</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">following</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="gp">In [150]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">group_demeaned</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">two</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">two</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>

<span class="gp">In [151]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *,</span>
<span class="go">       `two` - avg(`two`) OVER (PARTITION BY `one` ROWS BETWEEN 5 PRECEDING AND 5 FOLLOWING) AS `group_demeaned`</span>
<span class="go">FROM my_data</span>
</pre></div>
</div>
</section>
<section id="top-k-operations">
<h2 id="top-k-operations">Top-K operations<a class="headerlink" href="#top-k-operations" title="Permalink to this headline">¶</a></h2>
<p>A common SQL idiom is the “top-K” or “top-N” operation: subsetting a dimension
by aggregate statistics:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">key1</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="o">`</span><span class="k">count</span><span class="o">`</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">table1</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">`</span><span class="k">count</span><span class="o">`</span><span class="w"> </span><span class="k">DESC</span><span class="w"></span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
</pre></div>
</div>
<p>Ibis has a special analytic expression <code class="docutils literal notranslate"><span class="pre">topk</span></code>:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [152]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">key1</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>This can be evaluated directly, yielding the above query:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [153]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *</span>
<span class="go">FROM (</span>
<span class="go">  SELECT `key1`, count(`key1`) AS `count`</span>
<span class="go">  FROM table1</span>
<span class="go">  GROUP BY 1</span>
<span class="go">) t0</span>
<span class="go">ORDER BY `count` DESC</span>
<span class="go">LIMIT 10</span>
</pre></div>
</div>
<p>You can also use <code class="docutils literal notranslate"><span class="pre">expr</span></code> as a filter:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [154]: </span><span class="n">expr2</span> <span class="o">=</span> <span class="n">t1</span><span class="p">[</span><span class="n">expr</span><span class="p">]</span>

<span class="gp">In [155]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr2</span><span class="p">))</span>
<span class="go">SELECT t0.*</span>
<span class="go">FROM table1 t0</span>
<span class="go">  LEFT SEMI JOIN (</span>
<span class="go">    SELECT *</span>
<span class="go">    FROM (</span>
<span class="go">      SELECT `key1`, count(`key1`) AS `count`</span>
<span class="go">      FROM table1</span>
<span class="go">      GROUP BY 1</span>
<span class="go">    ) t2</span>
<span class="go">    ORDER BY `count` DESC</span>
<span class="go">    LIMIT 10</span>
<span class="go">  ) t1</span>
<span class="go">    ON t0.`key1` = t1.`key1`</span>
</pre></div>
</div>
</section>
<section id="date-time-data">
<h2 id="date-time-data">Date / time data<a class="headerlink" href="#date-time-data" title="Permalink to this headline">¶</a></h2>
<p>See <a class="reference internal" href="../api.html#api-timestamp"><span class="std std-ref">Timestamp methods</span></a> for a table of available date/time
methods.</p>
<p>For example, we can do:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [156]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">events</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">year</span><span class="p">(),</span>
<span class="gp">   .....: </span>                     <span class="n">month</span><span class="o">=</span><span class="n">events</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">month</span><span class="p">())</span>
<span class="gp">   .....: </span>

<span class="gp">In [157]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *, extract(`ts`, 'month') AS `month`, extract(`ts`, 'year') AS `year`</span>
<span class="go">FROM events</span>
</pre></div>
</div>
<section id="casting-to-date-time-types">
<h3 id="casting-to-date-time-types">Casting to date / time types<a class="headerlink" href="#casting-to-date-time-types" title="Permalink to this headline">¶</a></h3>
<p>In many cases, you can convert string values to datetime / timestamp with
<code class="docutils literal notranslate"><span class="pre">strings.cast('timestamp')</span></code>, but you may have to do some more reconnaissance
into the data if this does not work.</p>
</section>
<section id="timedeltas">
<h3 id="timedeltas">Timedeltas<a class="headerlink" href="#timedeltas" title="Permalink to this headline">¶</a></h3>
<p>Ibis has a set of <em>timedelta</em> object that allow you to do date/time
arithmetic. For example:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [158]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">events</span><span class="o">.</span><span class="n">ts</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">ibis</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">))]</span>

<span class="gp">In [159]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *</span>
<span class="go">FROM events</span>
<span class="go">WHERE `ts` &gt; date_sub(cast(now() as timestamp), INTERVAL 1 YEAR)</span>
</pre></div>
</div>
<p>The implementation of each timedelta offset will depend on the query engine.</p>
</section>
</section>
<section id="buckets-and-histograms">
<h2 id="buckets-and-histograms">Buckets and histograms<a class="headerlink" href="#buckets-and-histograms" title="Permalink to this headline">¶</a></h2>
<p>To appear.</p>
</section>
<section id="unions">
<h2 id="unions">Unions<a class="headerlink" href="#unions" title="Permalink to this headline">¶</a></h2>
<p>SQL dialects often support two kinds of <code class="docutils literal notranslate"><span class="pre">UNION</span></code> operations:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">UNION</span></code>: the combination of <em>distinct</em> rows from each table.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UNION</span> <span class="pre">ALL</span></code>: the combination of all rows from each table, whether or not
they are distinct.</p></li>
</ul>
<p>The Ibis <code class="docutils literal notranslate"><span class="pre">union</span></code> function by distinct is a <code class="docutils literal notranslate"><span class="pre">UNION</span> <span class="pre">ALL</span></code>, and you can set
<code class="docutils literal notranslate"><span class="pre">distinct=True</span></code> to get the normal <code class="docutils literal notranslate"><span class="pre">UNION</span></code> behavior:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [160]: </span><span class="n">expr1</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="gp">In [161]: </span><span class="n">expr2</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="gp">In [162]: </span><span class="n">expr</span> <span class="o">=</span> <span class="n">expr1</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">expr2</span><span class="p">)</span>

<span class="gp">In [163]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="go">SELECT *</span>
<span class="go">FROM table1</span>
<span class="go">LIMIT 10</span>
<span class="go">UNION ALL</span>
<span class="go">SELECT *</span>
<span class="go">FROM table1</span>
<span class="go">LIMIT 10 OFFSET 10</span>
</pre></div>
</div>
</section>
<section id="esoterica">
<h2 id="esoterica">Esoterica<a class="headerlink" href="#esoterica" title="Permalink to this headline">¶</a></h2>
<p>This area will be the spillover for miscellaneous SQL concepts and how queries
featuring them can be ported to Ibis.</p>
<section id="common-table-expressions-ctes">
<h3 id="common-table-expressions-ctes">Common table expressions (CTEs)<a class="headerlink" href="#common-table-expressions-ctes" title="Permalink to this headline">¶</a></h3>
<p>The simplest SQL CTE is a SQL statement that is used multiple times in a
<code class="docutils literal notranslate"><span class="pre">SELECT</span></code> query, which can be “factored” out using the <code class="docutils literal notranslate"><span class="pre">WITH</span></code> keyword:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">WITH</span><span class="w"> </span><span class="n">t0</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">   </span><span class="k">SELECT</span><span class="w"> </span><span class="n">region</span><span class="p">,</span><span class="w"> </span><span class="n">kind</span><span class="p">,</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total</span><span class="w"></span>
<span class="w">   </span><span class="k">FROM</span><span class="w"> </span><span class="n">purchases</span><span class="w"></span>
<span class="w">   </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">t0</span><span class="p">.</span><span class="n">region</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">.</span><span class="n">total</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">total</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">t0</span><span class="w"></span>
<span class="w">  </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">t0</span><span class="w"> </span><span class="n">t1</span><span class="w"></span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">t0</span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">region</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">t0</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'foo'</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'bar'</span><span class="w"></span>
</pre></div>
</div>
<p>Explicit CTEs are not necessary with Ibis. Let’s look at an example involving
joining an aggregated table on itself after filtering:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [164]: </span><span class="n">purchases</span> <span class="o">=</span> <span class="n">ibis</span><span class="o">.</span><span class="n">table</span><span class="p">([(</span><span class="s1">'region'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
<span class="gp">   .....: </span>                        <span class="p">(</span><span class="s1">'kind'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
<span class="gp">   .....: </span>                        <span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="s1">'int64'</span><span class="p">),</span>
<span class="gp">   .....: </span>                        <span class="p">(</span><span class="s1">'amount'</span><span class="p">,</span> <span class="s1">'double'</span><span class="p">)],</span> <span class="s1">'purchases'</span><span class="p">)</span>
<span class="gp">   .....: </span>

<span class="gp">In [165]: </span><span class="n">metric</span> <span class="o">=</span> <span class="n">purchases</span><span class="o">.</span><span class="n">amount</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s1">'total'</span><span class="p">)</span>

<span class="gp">In [166]: </span><span class="n">agged</span> <span class="o">=</span> <span class="p">(</span><span class="n">purchases</span><span class="o">.</span><span class="n">group_by</span><span class="p">([</span><span class="s1">'region'</span><span class="p">,</span> <span class="s1">'kind'</span><span class="p">])</span>
<span class="gp">   .....: </span>         <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
<span class="gp">   .....: </span>

<span class="gp">In [167]: </span><span class="n">left</span> <span class="o">=</span> <span class="n">agged</span><span class="p">[</span><span class="n">agged</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">'foo'</span><span class="p">]</span>

<span class="gp">In [168]: </span><span class="n">right</span> <span class="o">=</span> <span class="n">agged</span><span class="p">[</span><span class="n">agged</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">'bar'</span><span class="p">]</span>

<span class="gp">In [169]: </span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">left</span><span class="o">.</span><span class="n">region</span> <span class="o">==</span> <span class="n">right</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
<span class="gp">   .....: </span>          <span class="p">[</span><span class="n">left</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
<span class="gp">   .....: </span>           <span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">total</span> <span class="o">-</span> <span class="n">right</span><span class="o">.</span><span class="n">total</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s1">'diff'</span><span class="p">)])</span>
<span class="gp">   .....: </span>
</pre></div>
</div>
<p>Ibis automatically creates a CTE for <code class="docutils literal notranslate"><span class="pre">agged</span></code>:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [170]: </span><span class="nb">print</span><span class="p">(</span><span class="n">ibis</span><span class="o">.</span><span class="n">impala</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
<span class="go">SELECT t0.`region`, t0.`total` - t1.`total` AS `diff`</span>
<span class="go">FROM (</span>
<span class="go">  SELECT `region`, `kind`, sum(`amount`) AS `total`</span>
<span class="go">  FROM purchases</span>
<span class="go">  WHERE `kind` = 'foo'</span>
<span class="go">  GROUP BY 1, 2</span>
<span class="go">) t0</span>
<span class="go">  INNER JOIN (</span>
<span class="go">    SELECT `region`, `kind`, sum(`amount`) AS `total`</span>
<span class="go">    FROM purchases</span>
<span class="go">    WHERE `kind` = 'bar'</span>
<span class="go">    GROUP BY 1, 2</span>
<span class="go">  ) t1</span>
<span class="go">    ON t0.`region` = t1.`region`</span>
</pre></div>
</div>
</section>
</section>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>

  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="configuration.html" title="Configuring Ibis"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> Configuring Ibis </span>
              </div>
            </a>
          
          
            <a href="topk.html" title="“Top-K” Filtering"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> “Top-K” Filtering </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2014-2022, Ibis Developers.
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 4.3.2.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-65303298-2', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>